@model List<Tawasul.Models.ViewModels.ConversationListViewModel>
@{
    ViewData["Title"] = "Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª";
    Layout = "_Layout";

    var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
}
<link rel="stylesheet" href="~/css/IndexChat.css" asp-append-version="true" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>


<div class="container mt-4">
    <div class="chat-container shadow-sm">

        <!-- ğŸ”¹ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
        <div class="chat-sidebar">
            <ul class="nav nav-tabs nav-fill border-bottom" id="chatTabs">
                <li class="nav-item">
                    <button class="nav-link active" id="tab-chats">ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="tab-groups">ğŸ‘¥ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</button>
                </li>
            </ul>

            <div class="p-3 border-bottom">
                <input type="text" id="userSearchInput" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." />
                <div id="userSearchResults" class="mt-2"></div>
            </div>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª -->
            <div id="chatList">
                @foreach (var c in Model.Where(x => x.Type == "Chat"))
                {
                    <div class="conv-item d-flex align-items-center gap-2"
                         data-id="@c.ConversationId" data-type="chat">
                        <img src="@(string.IsNullOrEmpty(c.PhotoUrl) ? "/images/default-avatar.png" : c.PhotoUrl)"
                             class="rounded-circle flex-shrink-0" width="42" height="42" />
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="fw-bold">@c.DisplayTitle</div>
                                @if (c.UnreadCount > 0)
                                {
                                    <span class="badge bg-primary rounded-pill badge-unread">@c.UnreadCount</span>
                                }
                            </div>
                            <div class="text-muted small">@c.LastMessage</div>
                        </div>
                    </div>
                }
            </div>


            <!-- Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
            <div class="p-3 border-bottom text-center" id="createGroupBox" style="display:none;">
                <button class="btn btn-primary w-100" id="btnNewGroup">â• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª -->
            <div id="groupList" class="d-none">
                @foreach (var g in Model.Where(x => x.Type == "Group"))
                {
                    <div class="conv-item d-flex align-items-center gap-2"
                         data-id="@g.ConversationId" data-type="group">
                        <img src="@(string.IsNullOrEmpty(g.PhotoUrl) ? "/images/avatars/group-avatar.png" : g.PhotoUrl)"
                             class="rounded-circle flex-shrink-0" width="42" height="42" />
                        <div class="flex-grow-1">
                            <div class="fw-bold">@g.DisplayTitle</div>
                            <div class="text-muted small">@g.LastMessage</div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- ğŸ”¹ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
        <div class="chat-messages">
            <div id="chatHeader" style="display:none;">
                <div class="d-flex align-items-center gap-2">
                    <img id="chatHeaderPhoto" src="/images/default-avatar.png" width="42" height="42" class="rounded-circle" />
                    <div>
                        <div id="chatHeaderName" class="fw-bold"></div>
                    </div>
                </div>
                <button id="btnGroupInfo" class="info-btn d-none" title="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©">â„¹ï¸</button>
            </div>

            <div id="chatBody" class="chat-body">
                <div id="emptyState">
                    <span style="letter-spacing:1px;">Tawasul ğŸ’¬</span>
                    <small>Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø§Ø®ØªØ± Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„</small>
                </div>
            </div>

            <!-- ğŸ”¹ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ÙÙ‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
            <div id="filePreviewArea" class="p-2 text-center border-top bg-white d-none">
                <div id="filePreviewContent"></div>
                <div class="mt-2">
                    <button id="btnEditImage" class="btn btn-sm btn-outline-secondary d-none">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>
                    <button id="btnRemovePreview" class="btn btn-sm btn-danger">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>


            <div class="chat-input" id="chatInputArea">
                <input type="file" id="fileInput" class="d-none" />
                <button type="button" id="attachBtn" class="btn btn-outline-secondary">ğŸ“</button>
                <input id="messageInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." disabled />
                <div id="filePreviewBox" class="w-100 p-2 bg-light border-top text-center d-none">
                    <div id="filePreviewContent"></div>
                    <div class="mt-2 d-flex justify-content-center gap-2">
                        <button id="btnPreviewFile" class="btn btn-outline-primary btn-sm">ğŸ“„ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                        <button id="btnCancelFile" class="btn btn-danger btn-sm">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>

                <button id="sendBtn" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
            </div>

        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="groupNameInput" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©..." />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary" id="saveGroupBtn">Ø¥Ù†Ø´Ø§Ø¡</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ–¼ï¸ Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù…Ù„ -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bg-dark border-0 text-center position-relative">
            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
                    data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="modal-body p-0">
                <img id="previewImage" src="" class="img-fluid rounded"
                     style="max-height:90vh; object-fit:contain;">
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <a id="downloadImageBtn" href="#" download
                   class="btn btn-light px-4 fw-bold">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</a>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ¥ Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù…Ù„ -->
<div class="modal fade" id="videoPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bg-dark border-0 text-center">
            <div class="modal-header border-0">
                <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
            </div>
            <div class="modal-body p-0">
                <video id="previewVideo" controls class="rounded" style="max-height:80vh; max-width:100%; object-fit:contain;">
                    Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.
                </video>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <a id="downloadVideoBtn" href="#" download class="btn btn-light px-4 fw-bold">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>
            </div>
        </div>
    </div>
</div>


<!-- ğŸ“„ Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª (PDF / DOCX / XLSX) -->
<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bg-dark border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title text-white fw-bold">ğŸ“„ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù</h5>
                <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
            </div>
            <div class="modal-body p-0" style="height:80vh;">
                <iframe id="previewFileFrame" src="" width="100%" height="100%" style="border:none; background:#1f2937;"></iframe>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <a id="downloadFileBtn" href="#" download class="btn btn-light px-4 fw-bold">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</a>
            </div>
        </div>
    </div>
</div>




<!-- ğŸ§© Ø³ÙƒØ±Ø¨Øª -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script>
    let currentType = null;
     const currentUserId = "@userId";



        // âœ… Ø¥Ø°Ø§ ØªÙ… ØªÙ…Ø±ÙŠØ± open ID ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ Ù†Ø­Ø§ÙˆÙ„ ÙØªØ­Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
       // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø£ÙˆÙ„ Ù…Ø±Ø©:
    $(document).ready(() => {
        const params = new URLSearchParams(window.location.search);
        const openId = params.get("open");

        // Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· â†’ Ø¥Ø®ÙØ§Ø¡ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        if (!openId) {
            $("#chatInputArea").hide();
            $("#emptyState").show();
        } else {
            $(`.conv-item[data-id='${openId}']`).trigger("click");
        }
    });

    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§Ø¯Ø«Ø© â†’ Ù†Ø®ÙÙŠ Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆÙ†Ø¸Ù‡Ø± Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    $(document).on("click", ".conv-item", function () {
        $(".conv-item").removeClass("active");
        $(this).addClass("active");

        $("#emptyState").hide();
        $("#chatInputArea").show();

        const id = $(this).data("id");
        const type = $(this).data("type");
        currentConvId = id;
        currentType = type;

        const name = $(this).find(".fw-bold:first").text().trim();
        const photo = $(this).find("img").attr("src") || "/images/avatars/default-avatar.png";

        $("#chatHeaderPhoto").attr("src", photo);
        $("#chatHeaderName").text(name);
        $("#chatHeader").show();

        if (type === "group") {
            $("#btnGroupInfo").removeClass("d-none").data("group-id", id);
        } else {
            $("#btnGroupInfo").addClass("d-none");
        }

        $("#chatBody").html('<div class="text-center text-muted mt-5">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>');
        $("#messageInput, #sendBtn").prop("disabled", false);

        $.get(`/Chat/LoadMessages/${id}`, function (data) {
            $("#chatBody").empty();
            data.forEach(m => appendMessage(m));
        });
    });



    // âœ… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…Ø­Ø§Ø¯Ø«Ø© Ø£Ùˆ Ù…Ø¬Ù…ÙˆØ¹Ø©
    $(document).on("click", ".conv-item", function () {
        $(".conv-item").removeClass("active");
        $(this).addClass("active");

        const id = $(this).data("id");
        const type = $(this).data("type");
        currentConvId = id;
            // ğŸŸ¢ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ø§Ø¯Ø¬ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    $(this).find(".badge-unread").remove();

        currentType = type;

        const name = $(this).find(".fw-bold:first").text().trim();
        const photo = $(this).find("img").attr("src") || "/images/avatars/default-avatar.png";

        $("#chatHeaderPhoto").attr("src", photo);
        $("#chatHeaderName").text(name);
        $("#chatHeader").show();

        if (type === "group") {
            $("#btnGroupInfo").removeClass("d-none").data("group-id", id);
        } else {
            $("#btnGroupInfo").addClass("d-none");
        }

        $("#chatBody").html('<div class="text-center text-muted mt-5">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>');
        $("#messageInput, #sendBtn").prop("disabled", false);

         

        $.get(`/Chat/LoadMessages/${id}`, function (data) {
            $("#chatBody").empty();
            data.forEach(m => appendMessage(m));
        });
    });



    // âœ… Ø²Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    $("#btnGroupInfo").on("click", function () {
        const id = $(this).data("group-id");
        if (id) window.location.href = `/Groups/Details/${id}`;
    });

    // âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
       $("#sendBtn").click(sendMessage);
       // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ù†ØªØ± Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø³ÙˆØ§Ø¡ Ù„Ù„Ù…Ù„ÙØ§Øª Ø£Ùˆ Ø§Ù„Ù†Øµ
    $("#messageInput").keypress(function(e) {
        if (e.which === 13) { // Ø²Ø± Ø§Ù„Ø§Ù†ØªØ±
            const text = $("#messageInput").val().trim();
            const file = $("#fileInput")[0].files[0];

            // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù†Øµ Ø£Ùˆ Ù…Ù„Ù
            if (text || file) {
                sendMessage();
                e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)
            }
        }
    });


        $("#messageInput").on("input", function() {
        const text = $(this).val().trim();
        const file = $("#fileInput")[0].files[0];

        // âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù†Øµ Ø£Ùˆ Ù…Ù„Ù
        if (text || file) {
            $("#sendBtn").prop("disabled", false);
        } else {
            $("#sendBtn").prop("disabled", true);
        }
    });

    function sendMessage() {
        const text = $("#messageInput").val().trim();
        const file = $("#fileInput")[0].files[0];

        // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† Ù†Øµ
        if (!text && !file) return;

        const formData = new FormData();
        formData.append("conversationId", currentConvId);
        formData.append("text", text || ""); // âœ… Ø£Ø±Ø³Ù„ Ù†Øµ ÙØ§Ø±Øº Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù†Øµ

        if (file) {
            console.log("ğŸ“ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±Ø³Ù„:", file.type);
            formData.append("file", file);
        }

        $.ajax({
            url: "/Chat/SendMessage",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: (msg) => {
                // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                appendMessage(msg);

                // âœ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
                $("#messageInput").val("");
                $("#fileInput").val("");

                // âœ… Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                $("#filePreviewArea").addClass("d-none");
                $("#filePreviewBox").addClass("d-none");
                $("#filePreviewContent").empty();
                $("#btnEditImage").addClass("d-none");

                // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                $("#sendBtn").prop("disabled", true);
            },
            error: (xhr) => {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:", xhr.responseText);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: " + xhr.responseText);
            }
        });
    }

        // ğŸ“ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²
    $("#fileInput").change(function () {
        const file = this.files[0];
        if (!file) return $("#filePreviewBox").addClass("d-none");

        const size = formatFileSize(file.size);
        $("#filePreviewBox").removeClass("d-none");
        $("#filePreviewContent").html(`
            <div class="d-flex align-items-center justify-content-center bg-white rounded p-2 shadow-sm">
                <span class="me-2">ğŸ“</span>
                <strong>${file.name}</strong>
                <small class="text-muted ms-2">(${size})</small>
            </div>
        `);
    });

    // âŒ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    $("#btnCancelFile").click(() => {
        $("#fileInput").val("");
        $("#filePreviewBox").addClass("d-none");
        $("#filePreviewContent").empty();
    });

    // ğŸ“„ Ø²Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    $("#btnPreviewFile").click(() => {
        const file = $("#fileInput")[0].files[0];
        if (!file) return;

        const type = (file.type || "").toLowerCase();
        const blobUrl = URL.createObjectURL(file);
        const iframe = $("#previewFileFrame");
        const downloadBtn = $("#downloadFileBtn");

        downloadBtn.attr("href", blobUrl);
        downloadBtn.attr("download", file.name);

        if (type.includes("pdf")) {
            iframe.attr("src", blobUrl);
        } else if (type.includes("word") || type.includes("officedocument.word")) {
            iframe.attr("src", `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(blobUrl)}`);
        } else if (type.includes("excel") || type.includes("spreadsheetml")) {
            iframe.attr("src", `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(blobUrl)}`);
        } else {
            alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø³Ø¨Ù‚Ù‹Ø§.");
            return;
        }

        $("#filePreviewModal").modal("show");
    });



    // ğŸ“ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø±ÙÙ‚
    $("#attachBtn").click(() => $("#fileInput").click());
        // âœ… Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù â†’ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
   $("#fileInput").on("change", function () {
           const file = this.files[0];
        const text = $("#messageInput").val().trim();

        if (file) {
            $("#sendBtn").prop("disabled", false);

            // âœ… Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù„Ø­Ù‚Ù„ Ø§Ù„Ù†Øµ Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ù†ØªØ±
            $("#messageInput").focus();
        } else if (!text) {
            $("#sendBtn").prop("disabled", true);
        }

    const previewArea = $("#filePreviewArea");
    const previewBox = $("#filePreviewBox");
    const previewContent = $("#filePreviewContent");
    
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    previewArea.addClass("d-none");
    previewBox.addClass("d-none");
    previewContent.empty();

    const type = file.type.toLowerCase();

    // ğŸ“¸ Ù„Ù„ØµÙˆØ± - Ø§Ø³ØªØ®Ø¯Ù… filePreviewArea
    if (type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = e => {
            previewContent.html(`
                <img id="previewImage" src="${e.target.result}"
                     class="img-fluid rounded shadow-sm"
                     style="max-height:300px; object-fit:contain;" />
            `);
            $("#btnEditImage").removeClass("d-none");
        };
        reader.readAsDataURL(file);
        previewArea.removeClass("d-none");
    }
    // ğŸ¥ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ - Ø§Ø³ØªØ®Ø¯Ù… filePreviewArea
    else if (type.startsWith("video/")) {
        const url = URL.createObjectURL(file);
        previewContent.html(`
            <video controls style="max-width:100%; border-radius:10px; max-height:300px;">
                <source src="${url}" type="${type}">
                Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.
            </video>
        `);
        $("#btnEditImage").addClass("d-none");
        previewArea.removeClass("d-none");
    }
    // ğŸ”Š Ù„Ù„ØµÙˆØª - Ø§Ø³ØªØ®Ø¯Ù… filePreviewArea
    else if (type.startsWith("audio/")) {
        const url = URL.createObjectURL(file);
        previewContent.html(`
            <div class="d-flex flex-column align-items-center">
                <audio controls style="width:100%; max-width:300px;">
                    <source src="${url}" type="${type}">
                    Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØª.
                </audio>
                <div class="mt-2 text-muted small">${file.name}</div>
            </div>
        `);
        $("#btnEditImage").addClass("d-none");
        previewArea.removeClass("d-none");
    }
    // ğŸ“„ Ø£ÙŠ Ù…Ù„ÙØ§Øª Ø£Ø®Ø±Ù‰ - Ø§Ø³ØªØ®Ø¯Ù… filePreviewBox
    else {
        const size = formatFileSize(file.size);
        previewContent.html(`
            <div class="d-flex align-items-center justify-content-center bg-white rounded p-2 shadow-sm">
                <span class="me-2">ğŸ“</span>
                <strong>${file.name}</strong>
                <small class="text-muted ms-2">(${size})</small>
            </div>
        `);
        $("#btnEditImage").addClass("d-none");
        previewBox.removeClass("d-none");
    }
});

    // âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
       $("#btnRemovePreview").on("click", function () {
        $("#fileInput").val("");
        $("#filePreviewArea").addClass("d-none");
        $("#filePreviewBox").addClass("d-none");
        $("#filePreviewContent").empty();
        $("#btnEditImage").addClass("d-none");
    });

    // âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Cropper.js
    let cropper = null;
    $("#btnEditImage").on("click", function () {
        const img = document.getElementById("previewImage");
        if (!img) return;

        const modalHtml = `
            <div class="modal fade" id="editImageModal" tabindex="-1">
                   <div class="modal-dialog modal-xl modal-dialog-centered">
           <div class="modal-content" style="background: #fff; color: #000; border: none; border-radius: 14px;">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" style="max-height: 80vh; overflow: hidden;">
                <img id="cropImage" src="${img.src}"
                     style="max-width: 100%; max-height: 75vh; border-radius: 12px;" />
            </div>
            <div class="modal-footer border-0 justify-content-between">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" id="btnCropApply" class="btn btn-success px-4 fw-bold">âœ”ï¸ Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

            </div>`;
        $("body").append(modalHtml);
        const modal = new bootstrap.Modal(document.getElementById("editImageModal"));
        modal.show();

        const cropImg = document.getElementById("cropImage");
        cropper = new Cropper(cropImg, { aspectRatio: NaN, viewMode: 1 });

        $("#btnCropApply").on("click", function () {
            const canvas = cropper.getCroppedCanvas({ maxWidth: 1024, maxHeight: 1024 });
            $("#previewImage").attr("src", canvas.toDataURL("image/png"));
            modal.hide();
            $("#editImageModal").remove();
            cropper.destroy();
            cropper = null;
        });

        $("#editImageModal").on("hidden.bs.modal", () => {
            if (cropper) cropper.destroy();
            $("#editImageModal").remove();
        });
    });




         function appendMessage(m) {
        let filePreview = "";
        const name = m.fileName || "Ù…Ù„Ù Ù…Ø±ÙÙ‚";
        const type = (m.fileType || "").toLowerCase();
        const fileUrl = m.fileUrl;
        const fileSize = m.fileSize || 0;

        // ğŸ”¹ Ù„Ù„ØµÙˆØ±
        if (type.startsWith("image/")) {
            filePreview = `
                <div class="position-relative mt-2">
                    <img src="${fileUrl}" alt="${name}"
                         class="chat-image"
                         style="max-width:200px; max-height:200px; border-radius:12px; object-fit:cover; cursor:pointer;" />
                    <a href="${fileUrl}" download="${name}" class="btn btn-sm btn-light position-absolute bottom-0 end-0 m-2 shadow-sm">
                        â¬‡ï¸
                    </a>
                </div>`;
        }
        // ğŸ”¹ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ
        else if (type.startsWith("video/")) {
            filePreview = `
                <div class="position-relative mt-2">
                    <video class="chat-video" style="max-width:220px; max-height:200px; border-radius:12px; cursor:pointer;" controls>
                        <source src="${fileUrl}" type="${type}">
                        Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.
                    </video>
                    <a href="${fileUrl}" download="${name}" class="btn btn-sm btn-light position-absolute bottom-0 end-0 m-2 shadow-sm">
                        â¬‡ï¸
                    </a>
                </div>`;
        }
        // ğŸ”¹ Ù„Ù„ØµÙˆØª
        else if (type.startsWith("audio/")) {
            filePreview = `
                <div class="d-flex align-items-center mt-2 bg-light rounded p-2" style="max-width:240px;">
                    <audio controls style="width:180px;">
                        <source src="${fileUrl}" type="${type}">
                    </audio>
                    <a href="${fileUrl}" download="${name}" class="btn btn-sm btn-outline-secondary ms-2">â¬‡ï¸</a>
                </div>`;
        }
        // ğŸ”¹ Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø­Ø³Ù†
        else if (fileUrl) {
            filePreview = `
            <div class="position-relative mt-2">
                <div class="chat-file d-flex align-items-center p-3 rounded shadow-sm"
                     data-file="${fileUrl}" data-type="${type}">
                    <div class="me-2 fs-4">ğŸ“„</div>
                    <div class="file-info-container">
                        <div class="file-name">${name}</div>
                        <div class="file-details">
                            <span class="file-size">${formatFileSize(fileSize)}</span>
                            <span class="file-type">${type.split('/')[1] || 'Ù…Ù„Ù'}</span>
                        </div>
                    </div>
                </div>
                <a href="${fileUrl}" download="${name}" class="btn btn-sm btn-outline-secondary mt-2">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</a>
            </div>`;
        }

        const html = `
        <div class="msg ${m.isMine ? "me" : "other"}" data-id="${m.id}">
            <div class="msg-content position-relative">
                ${m.text ? `<div>${m.text}</div>` : ""}
                ${m.isEdited ? `<small class="text-muted fst-italic">(Ù…Ø¹Ø¯Ù„Ø©)</small>` : ""}
                ${filePreview}
                <div class="small mt-1 text-end opacity-75">
                    ${new Date(m.createdAtUtc).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
                ${m.isMine ? `
                    <div class="msg-actions">
                        <button class="btn btn-sm btn-light edit-msg">âœï¸</button>
                        <button class="btn btn-sm btn-danger delete-msg">ğŸ—‘ï¸</button>
                    </div>
                ` : ""}
            </div>
        </div>`;

        $("#chatBody").append(html);
        $("#chatBody").scrollTop($("#chatBody")[0].scrollHeight);
    }

        $(document).on("click", ".edit-msg", function () {
        const msgDiv = $(this).closest(".msg");
        const msgId = msgDiv.data("id");
        const oldText = msgDiv.find(".msg-content > div:first").text().trim();

        Swal.fire({
            title: "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©",
            input: "textarea",
            inputValue: oldText,
            inputAttributes: {
                "aria-label": "Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"
            },
            showCancelButton: true,
            confirmButtonText: "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„",
            cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
            confirmButtonColor: "#2563eb",
            cancelButtonColor: "#6c757d",
            background: "#fff",
            customClass: {
                popup: "rounded-4 shadow-lg p-4",
                title: "fw-bold fs-5 text-primary",
                confirmButton: "btn btn-primary px-4 fw-bold",
                cancelButton: "btn btn-secondary px-4 fw-bold"
            },
            preConfirm: (value) => {
                if (!value.trim()) {
                    Swal.showValidationMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.");
                }
                return value.trim();
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const newText = result.value;

                $.post("/Chat/EditMessage", { messageId: msgId, newText: newText }, function(response) {
                    if (response.success) {
                        // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                        msgDiv.find(".msg-content > div:first").text(newText);

                        // âœ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© (Ù…Ø¹Ø¯Ù„Ø©) Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                        if (msgDiv.find(".text-muted.fst-italic").length === 0) {
                            msgDiv.find(".msg-content").append('<small class="text-muted fst-italic">(Ù…Ø¹Ø¯Ù„Ø©)</small>');
                        }

                        // âœ… Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
                        const Toast = Swal.mixin({
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                        });
                        Toast.fire({
                            icon: "success",
                            title: "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­"
                        });
                    }
                }).fail(function() {
                    Swal.fire("âŒ Ø®Ø·Ø£", "ÙØ´Ù„ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©", "error");
                });
            }
        });
    });





      $(document).on("click", ".delete-msg", function () {
        const msgDiv = $(this).closest(".msg");
        const msgId = msgDiv.data("id");

        Swal.fire({
            title: "ğŸ—‘ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
            text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ ÙˆÙ„Ù† ØªÙƒÙˆÙ† Ù…Ø±Ø¦ÙŠØ© Ù„Ø£ÙŠ Ù…Ù† Ø§Ù„Ø·Ø±ÙÙŠÙ†.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡Ø§",
            cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
            reverseButtons: true,
            customClass: {
                popup: "rounded-4 shadow-lg p-4",
                title: "fw-bold fs-5",
                confirmButton: "btn btn-danger px-4 fw-bold",
                cancelButton: "btn btn-secondary px-4 fw-bold"
            }
        }).then((result) => {
            if (result.isConfirmed) {
                $.post("/Chat/DeleteMessage", {
                    messageId: msgId,
                    deleteForAll: true
                }, function(response) {
                    // ğŸ”¥ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹ Ù…Ø¹ ØªØ£Ø«ÙŠØ±
                    msgDiv.animate({
                        opacity: 0,
                        height: 0,
                        marginTop: 0,
                        marginBottom: 0,
                        paddingTop: 0,
                        paddingBottom: 0
                    }, 300, function() {
                        $(this).remove();

                        // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
                        const Toast = Swal.mixin({
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                        });
                        Toast.fire({
                            icon: "success",
                            title: "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­"
                        });
                    });
                }).fail(function() {
                    Swal.fire("âŒ Ø®Ø·Ø£", "ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©", "error");
                });
            }
        });
    });





        // ğŸ§© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª
    $(document).on("click", ".chat-image", function () {
        const src = $(this).attr("src");
        const fileName = $(this).attr("alt") || "image";
        $("#previewImage").attr("src", src);
        $("#downloadImageBtn").attr("href", src);
        $("#downloadImageBtn").attr("download", fileName);
        $("#imagePreviewModal").modal("show");
    });


    // ğŸ§® ØªÙ†Ø³ÙŠÙ‚ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        if (bytes < 1024) return `${bytes} B`;
        const kb = bytes / 1024;
        if (kb < 1024) return `${kb.toFixed(1)} KB`;
        const mb = kb / 1024;
        if (mb < 1024) return `${mb.toFixed(1)} MB`;
        const gb = mb / 1024;
        return `${gb.toFixed(1)} GB`;
    }

    // ğŸªŸ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© â†’ ÙØªØ­ Ù…Ø¹Ø§ÙŠÙ†Ø© ÙƒØ§Ù…Ù„Ø©
    $(document).on("click", ".chat-img", function () {
        const src = $(this).attr("src");
        const modal = `
            <div class="modal fade" id="imgPreviewModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content bg-transparent border-0 shadow-none">
                        <img src="${src}" class="w-100 rounded shadow-lg" />
                    </div>
                </div>
            </div>`;
        $("body").append(modal);
        const m = new bootstrap.Modal(document.getElementById("imgPreviewModal"));
        m.show();
        $("#imgPreviewModal").on("hidden.bs.modal", () => $("#imgPreviewModal").remove());
    });

        // ğŸ¥ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª
    $(document).on("click", ".chat-video", function () {
        const src = $(this).find("source").attr("src");
        $("#previewVideo").attr("src", src);
        $("#downloadVideoBtn").attr("href", src);
        $("#downloadVideoBtn").attr("download", "video.mp4");
        $("#videoPreviewModal").modal("show");
    });

    // ğŸ§¹ Ù„Ù…Ø§ ÙŠØºÙ„Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ØŒ Ù†ÙˆÙ‚Ù ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    $('#videoPreviewModal').on('hidden.bs.modal', function () {
        const video = document.getElementById("previewVideo");
        if (video) {
            video.pause();
            video.currentTime = 0;
        }
    });


        // ğŸ“„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…Ù„Ù (PDF / Word / Excel)
    $(document).on("click", ".chat-file", function () {
        const fileUrl = $(this).data("file");
        const type = ($(this).data("type") || "").toLowerCase();
        const iframe = $("#previewFileFrame");
        const downloadBtn = $("#downloadFileBtn");

        downloadBtn.attr("href", fileUrl);

        if (type.includes("pdf")) {
            // Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø± Ø¯Ø§Ø®Ù„ iframe
            iframe.attr("src", fileUrl);
        }
        else if (type.includes("word") || type.includes("officedocument.word")) {
            // Ø¹Ø±Ø¶ Word Ø¹Ø¨Ø± Office Viewer
            iframe.attr("src", `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(fileUrl)}`);
        }
        else if (type.includes("excel") || type.includes("spreadsheetml")) {
            // Ø¹Ø±Ø¶ Excel Ø¹Ø¨Ø± Office Viewer
            iframe.attr("src", `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(fileUrl)}`);
        }
        else {
            // Ø£Ù†ÙˆØ§Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© â†’ Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø·
            iframe.attr("src", "");
            alert("Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø¹Ø§ÙŠÙ†ØªÙ‡ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©.");
            return;
        }

        $("#filePreviewModal").modal("show");
    });




    // âœ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
    $("#tab-chats").click(() => {
        $("#tab-chats").addClass("active");
        $("#tab-groups").removeClass("active");
        $("#chatList").removeClass("d-none");
        $("#groupList").addClass("d-none");
        $("#createGroupBox").hide();
        $("#userSearchInput").attr("placeholder", "Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...");
    });

    $("#tab-groups").click(() => {
        $("#tab-groups").addClass("active");
        $("#tab-chats").removeClass("active");
        $("#groupList").removeClass("d-none");
        $("#chatList").addClass("d-none");
        $("#createGroupBox").show();
        $("#userSearchInput").attr("placeholder", "Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©...");
    });

    // âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    $("#btnNewGroup").click(() => $("#createGroupModal").modal("show"));
    $("#saveGroupBtn").click(() => {
        let title = $("#groupNameInput").val().trim();
        if (!title) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.");
        $.post("/Groups/Create", { title }, () => location.reload())
         .fail(() => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©."));
    });




        $("#userSearchInput").on("keyup", function () {
        const q = $(this).val().trim();
        if (q.length < 2) return $("#userSearchResults").empty();

       const url = `/Chat/SearchUsers`;


        $.get(url, { query: q }, users => {
            const box = $("#userSearchResults");
            box.empty();

            if (users.length === 0) {
                box.html('<div class="text-muted text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>');
                return;
            }

            users.forEach(u => {
                box.append(`
                    <div class="d-flex align-items-center justify-content-between p-2 border rounded mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <img src="${u.photoUrl ?? '/images/default-avatar.png'}" width="35" height="35" class="rounded-circle" />
                            <div>
                                <strong>${u.displayName ?? "(Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ)"}</strong><br/>
                                <small class="text-muted">${u.email ?? ""}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary btnStartChat" data-id="${u.id}">Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©</button>
                    </div>
                `);
            });
        });
    });


        // âœ… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©"
    $(document).on("click", ".btnStartChat", function () {
        const targetUserId = $(this).data("id");

        $.post("/Chat/StartChat", { targetUserId }, res => {
            if (res.conversationId) {
                // Ù†Ø¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆÙ†ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                location.href = `/Chat?open=${res.conversationId}`;
            } else {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.");
            }
        }).fail(() => {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.");
        });
    });

   
</script>



<script src="~/js/IndexChat.js" asp-append-version="true"></script>
<!-- ğŸ§© Ù…ÙƒØªØ¨Ø© SignalR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script>
    // âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ SignalR
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/hubs/tawasul")
        .build();

  

    // âœ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    connection.on("ReceiveMessage", (msg) => {
        console.log("ğŸ“© Received:", msg);

        // ğŸ§  ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ Ø§Ù„Ù…Ø±Ø³Ù„ Ù‡Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        if (msg.senderId === currentUserId) return;

        // âœ… Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø©
        if (msg.conversationId === currentConvId) {
            appendMessage(msg);
        } else {
            // ğŸ”µ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„Ø© Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø£Ø®Ø±Ù‰ â†’ Ø£Ø¶Ù Badge
            const item = $(`.conv-item[data-id='${msg.conversationId}']`);
            if (item.length) {
                let badge = item.find(".badge-unread");
                if (badge.length === 0) {
                    item.find(".fw-bold")
                        .after(`<span class="badge bg-primary rounded-pill badge-unread ms-2">1</span>`);
                } else {
                    let count = parseInt(badge.text()) || 0;
                    badge.text(count + 1);
                }
            } else {
                console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:", msg.conversationId);
            }
        }
    });

    // âœ… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Online / Offline)
    connection.on("UserStatusChanged", (userId, isOnline) => {
        console.log(`ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userId} Ø§Ù„Ø¢Ù† ${isOnline ? "Ù…ØªØµÙ„" : "ØºÙŠØ± Ù…ØªØµÙ„"}`);
    });

    // âœ… Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
    connection.start()
        .then(() => console.log("âœ… Connected to ChatHub!"))
        .catch(err => console.error("âŒ Hub Error:", err));

    // âœ… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…Ø­Ø§Ø¯Ø«Ø©
    $(document).on("click", ".conv-item", function () {
        const id = $(this).data("id");
        currentConvId = id;

        // ğŸŸ¢ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ø§Ø¯Ø¬
        $(this).find(".badge-unread").remove();

        // Ø§Ù†Ø¶Ù… Ù„ØºØ±ÙØ© SignalR
        if (connection.state === signalR.HubConnectionState.Connected) {
            connection.invoke("JoinConversation", id.toString());
        }
    });

       // Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø©
    connection.on("MessageEdited", (msg) => {
        const div = $(`.msg[data-id='${msg.id}']`);
        div.find(".msg-content > div:first").text(msg.text);
        if (div.find(".text-muted.fst-italic").length === 0)
            div.find(".msg-content").append(`<small class="text-muted fst-italic">(Ù…Ø¹Ø¯Ù„Ø©)</small>`);
    });

    // Ø¹Ù†Ø¯ Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø©
     // Ø¹Ù†Ø¯ Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± SignalR
    connection.on("MessageDeleted", (data) => {
        const msgDiv = $(`.msg[data-id='${data.id}']`);

        if (msgDiv.length > 0) {
            if (data.deletedCompletely) {
                // ğŸ”¥ Ø­Ø°Ù ÙƒØ§Ù…Ù„ - Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                msgDiv.animate({
                    opacity: 0,
                    height: 0,
                    marginTop: 0,
                    marginBottom: 0,
                    paddingTop: 0,
                    paddingBottom: 0
                }, 300, function() {
                    $(this).remove();
                });
            } else {
                // Ø­Ø°Ù Ø¬Ø²Ø¦ÙŠ (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·)
                msgDiv.html('<div class="text-muted fst-italic p-2 text-center">ğŸš« ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div>');
            }
        }
    });




</script>











--------------------------------------------------------------
/* ğŸŒ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
:root {
    --primary: #7B68EE;
    --primary-light: #9370DB;
    --primary-dark: #6A5ACD;
    --secondary: #20B2AA;
    --accent: #FF69B4;
    --background: #F8F9FF;
    --surface: #FFFFFF;
    --text-primary: #2D3748;
    --text-secondary: #718096;
    --border: #E2E8F0;
    --shadow: rgba(123, 104, 238, 0.15);
    --gradient: linear-gradient(135deg, #7B68EE, #20B2AA);
    --gradient-light: linear-gradient(135deg, #9370DB, #48D1CC);
    --success: #48BB78;
    --warning: #ED8936;
    --error: #F56565;
}

/* ğŸ¨ Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© */
body {
    background: var(--background);
    font-family: 'Segoe UI', 'Tajawal', sans-serif;
}

/* ğŸ§© Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© */
.chat-container {
    display: flex;
    height: calc(100vh - 100px);
    border: 1px solid var(--border);
    border-radius: 20px;
    overflow: hidden;
    background: var(--surface);
    box-shadow: 0 0 40px var(--shadow);
}

/* ğŸ”¹ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.chat-sidebar {
    width: 350px;
    background: var(--surface);
    border-inline-end: 1px solid var(--border);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

    /* ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
    .chat-sidebar .nav-tabs {
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: 0;
        margin: 0;
    }

        .chat-sidebar .nav-tabs .nav-item {
            flex: 1;
        }

        .chat-sidebar .nav-tabs .nav-link {
            border: none;
            background: none;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

            .chat-sidebar .nav-tabs .nav-link.active {
                color: var(--primary);
            }

                .chat-sidebar .nav-tabs .nav-link.active::after {
                    content: '';
                    position: absolute;
                    bottom: 0;
                    right: 0;
                    width: 100%;
                    height: 3px;
                    background: var(--gradient);
                    border-radius: 3px 3px 0 0;
                }

            .chat-sidebar .nav-tabs .nav-link:hover {
                background: rgba(123, 104, 238, 0.05);
            }

    /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    .chat-sidebar .conv-item {
        padding: 15px;
        cursor: pointer;
        border-bottom: 1px solid var(--border);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

        .chat-sidebar .conv-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 0;
            background: var(--gradient);
            transition: height 0.3s ease;
        }

        .chat-sidebar .conv-item:hover::before {
            height: 100%;
        }

        .chat-sidebar .conv-item:hover {
            background: rgba(123, 104, 238, 0.05);
        }

        .chat-sidebar .conv-item.active {
            background: rgba(123, 104, 238, 0.1);
        }

            .chat-sidebar .conv-item.active::before {
                height: 100%;
            }

        .chat-sidebar .conv-item .rounded-circle {
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .chat-sidebar .conv-item.active .rounded-circle {
            border-color: var(--primary);
        }

/* Ø§Ù„Ø¨Ø§Ø¯Ø¬ - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.badge-unread {
    background: var(--primary) !important;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
}

/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨Ø­Ø« */
.chat-sidebar .p-3 {
    border-bottom: 1px solid var(--border);
}

.chat-sidebar .form-control {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 15px;
    background: var(--background);
    transition: all 0.3s ease;
}

    .chat-sidebar .form-control:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px var(--shadow);
    }

/* Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© */
#createGroupBox .btn-primary {
    background: var(--gradient);
    border: none;
    border-radius: 12px;
    padding: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
}

    #createGroupBox .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px var(--shadow);
    }

/* ğŸ’¬ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.chat-messages {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--background);
}

.chat-body {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

/* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
#emptyState {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    height: 100%;
    color: var(--text-secondary);
    font-weight: 700;
    font-size: 2.8rem;
    opacity: 0;
    animation: fadeIn 0.8s ease forwards;
    user-select: none;
    text-align: center;
}

    #emptyState span {
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: pulse 4s ease-in-out infinite;
    }

    #emptyState small {
        font-size: 1rem;
        margin-top: 10px;
        opacity: 0.7;
        color: var(--text-secondary);
    }

/* ğŸ¨ Ø±Ø³Ø§Ø¦Ù„ Tawasul Theme - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.msg {
    position: relative;
    margin: 10px 0;
    border-radius: 18px;
    max-width: 70%;
    word-wrap: break-word;
    transition: all 0.2s ease;
    animation: messageAppear 0.3s ease;
    display: flex;
}

    .msg.me {
        justify-content: flex-end;
        margin-left: auto;
    }

    .msg.other {
        justify-content: flex-start;
        margin-right: auto;
    }

    /* ğŸŒˆ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ */
    .msg.me .msg-content {
        background: var(--gradient);
        color: #fff;
        border-radius: 18px;
        padding: 12px 16px;
        box-shadow: 0 3px 8px var(--shadow);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border-bottom-right-radius: 5px;
        margin-left: 0;
    }

        .msg.me .msg-content:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 14px var(--shadow);
        }

    /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± */
    .msg.other .msg-content {
        background: var(--surface);
        color: var(--text-primary);
        border-radius: 18px;
        padding: 12px 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        border-bottom-left-radius: 5px;
        margin-right: 0;
    }

    /* ğŸ•“ Ø§Ù„ÙˆÙ‚Øª */
    .msg .small {
        font-size: 0.7rem;
        margin-top: 5px;
    }

    .msg.me .small {
        color: rgba(255, 255, 255, 0.85);
        text-align: right;
    }

    .msg.other .small {
        color: var(--text-secondary);
        text-align: left;
    }

/* âœï¸ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.msg-actions {
    position: absolute;
    top: -25px;
    display: flex;
    gap: 5px;
    opacity: 0;
    transform: translateY(-4px);
    transition: all 0.2s ease-in-out;
    z-index: 1000;
}

.msg.me .msg-actions {
    right: 10px;
    left: auto;
}

.msg.other .msg-actions {
    left: 10px;
    right: auto;
}

.msg:hover .msg-actions {
    opacity: 1;
    transform: translateY(0);
}

.msg-actions button {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease-in-out;
    background: var(--surface);
}

.msg-actions .edit-msg {
    color: var(--primary);
}

    .msg-actions .edit-msg:hover {
        background-color: var(--primary);
        color: white;
        transform: scale(1.05);
    }

.msg-actions .delete-msg {
    color: var(--error);
}

    .msg-actions .delete-msg:hover {
        background-color: var(--error);
        color: white;
        transform: scale(1.05);
    }

/* Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
#chatHeader {
    display: none;
    padding: 15px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    align-items: center;
    justify-content: space-between;
}

    #chatHeader .d-flex {
        align-items: center;
    }

    #chatHeader .rounded-circle {
        border: 2px solid var(--border);
    }

    #chatHeader .fw-bold {
        color: var(--text-primary);
        font-size: 1.1rem;
    }

.info-btn {
    background: none;
    border: none;
    font-size: 1.2rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
}

    .info-btn:hover {
        color: var(--primary);
    }

/* ğŸ“ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.chat-input {
    display: flex;
    border-top: 1px solid var(--border);
    background: var(--surface);
    padding: 15px 20px;
    align-items: flex-end;
}

    .chat-input input {
        flex: 1;
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: 12px 20px;
        outline: none;
        background: var(--background);
        transition: all 0.3s ease;
    }

        .chat-input input:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px var(--shadow);
        }

/* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
#sendBtn {
    background: var(--gradient);
    color: #fff;
    font-weight: 600;
    border: none;
    padding: 12px 24px;
    border-radius: 24px;
    transition: all 0.25s ease;
    margin-right: 10px;
}

    #sendBtn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px var(--shadow);
    }

    #sendBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

/* Ø²Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
#attachBtn {
    border: 1px solid var(--primary);
    color: var(--primary);
    background: var(--surface);
    transition: all 0.25s ease;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 10px;
}

    #attachBtn:hover {
        background: var(--primary);
        color: var(--surface);
        transform: scale(1.05);
    }

/* Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„ÙØ§Øª - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
#filePreviewArea,
#filePreviewBox {
    background: var(--surface);
    border-top: 1px solid var(--border);
}

#filePreviewContent .img-fluid {
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
.btn-outline-primary {
    border-color: var(--primary);
    color: var(--primary);
}

    .btn-outline-primary:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

.btn-outline-secondary {
    border-color: var(--text-secondary);
    color: var(--text-secondary);
}

    .btn-outline-secondary:hover {
        background: var(--text-secondary);
        border-color: var(--text-secondary);
        color: white;
    }

.btn-danger {
    background: var(--error);
    border-color: var(--error);
}

    .btn-danger:hover {
        background: #e53e3e;
        border-color: #e53e3e;
    }

/* ğŸ“„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.chat-file {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    transition: all 0.3s ease;
    margin-top: 8px;
    max-width: 300px;
    display: flex;
    align-items: center;
    gap: 12px;
}

    .chat-file:hover {
        background: rgba(123, 104, 238, 0.05);
        border-color: var(--primary-light);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--shadow);
    }

    .chat-file .me-2 {
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .chat-file a,
    .msg a.btn-outline-secondary {
        color: var(--primary) !important;
        border-color: var(--primary) !important;
    }

        .chat-file a:hover,
        .msg a.btn-outline-secondary:hover {
            background: var(--primary) !important;
            color: #fff !important;
        }

/* ğŸ–¼ï¸ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.chat-img,
.chat-video {
    max-width: 300px;
    border-radius: 12px;
    display: block;
    cursor: pointer;
    object-fit: cover;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    margin-top: 8px;
}

    .chat-img:hover,
    .chat-video:hover {
        transform: scale(1.03);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    }

/* Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
#userSearchResults .d-flex {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 8px;
    transition: all 0.3s ease;
    background: var(--surface);
}

    #userSearchResults .d-flex:hover {
        background: rgba(123, 104, 238, 0.05);
        border-color: var(--primary-light);
    }

#userSearchResults .btn-primary {
    background: var(--primary);
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 0.9rem;
}

    #userSearchResults .btn-primary:hover {
        background: var(--primary-dark);
    }

/* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.modal-content {
    border: none;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
}

.modal-header {
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    border-radius: 20px 20px 0 0;
}

.modal-footer {
    border-top: 1px solid var(--border);
    background: var(--surface);
    border-radius: 0 0 20px 20px;
}

/* âœ¨ Ø­Ø±ÙƒØ§Øª */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(15px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0% {
        transform: scale(1);
        opacity: 0.7;
    }

    50% {
        transform: scale(1.03);
        opacity: 1;
    }

    100% {
        transform: scale(1);
        opacity: 0.7;
    }
}

@keyframes messageAppear {
    from {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes float {
    0% {
        transform: translateY(0px);
    }

    50% {
        transform: translateY(-10px);
    }

    100% {
        transform: translateY(0px);
    }
}

/* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØµØµ */
::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: var(--background);
}

::-webkit-scrollbar-thumb {
    background: var(--primary-light);
    border-radius: 3px;
}

    ::-webkit-scrollbar-thumb:hover {
        background: var(--primary);
    }

/* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù */
.file-info-container {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 0;
}

.file-name {
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
}

.file-details {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.file-size {
    background: rgba(123, 104, 238, 0.1);
    color: var(--primary);
    padding: 2px 6px;
    border-radius: 8px;
    font-weight: 500;
}

.file-type {
    color: var(--text-secondary);
}

/* ØªØ­Ø³ÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
.msg a.btn-outline-secondary,
.msg a.btn-sm {
    border: 1px solid var(--primary);
    color: var(--primary) !important;
    text-decoration: none;
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 0.8rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

    .msg a.btn-outline-secondary:hover,
    .msg a.btn-sm:hover {
        background: var(--primary);
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px var(--shadow);
    }

/* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
#filePreviewContent .bg-light {
    background: var(--surface) !important;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
}

#filePreviewContent .d-flex {
    align-items: center;
    gap: 12px;
}

#filePreviewContent strong {
    color: var(--text-primary);
    font-weight: 600;
}

#filePreviewContent .text-muted {
    color: var(--text-secondary) !important;
    font-size: 0.9rem;
}

/* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« */
#userSearchResults .border {
    border: 1px solid var(--border) !important;
    border-radius: 12px;
    transition: all 0.3s ease;
}

    #userSearchResults .border:hover {
        border-color: var(--primary-light) !important;
        background: rgba(123, 104, 238, 0.03);
    }

/* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© */
.text-muted.fst-italic {
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 16px;
    color: var(--text-secondary) !important;
    font-style: italic;
    text-align: center;
    margin: 0;
    max-width: 100% !important;
}

/* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ØªØ£Ø®Ø° Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„ØµØ­ÙŠØ­ */
.msg.me .text-muted.fst-italic {
    margin-left: auto;
    margin-right: 0;
}

.msg.other .text-muted.fst-italic {
    margin-right: auto;
    margin-left: 0;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ÙˆØ¶ÙˆØ­ */
.msg .position-relative {
    margin-top: 8px;
}

.msg .btn-light {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-primary);
    transition: all 0.3s ease;
}

    .msg .btn-light:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

/* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.msg .small.opacity-75 {
    opacity: 0.8 !important;
    font-size: 0.75rem;
    margin-top: 8px;
}

/* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± */
.msg .mt-1 {
    margin-top: 4px;
}

.msg .mt-2 {
    margin-top: 8px;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØª */
#filePreviewArea audio {
    border-radius: 12px;
    background: var(--surface);
    padding: 8px;
}

#filePreviewContent .d-flex.flex-column {
    gap: 8px;
}

#filePreviewContent .text-muted.small {
    color: var(--text-secondary) !important;
    font-size: 0.9rem;
    text-align: center;
}

/* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØª ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.msg audio {
    border-radius: 8px;
    background: var(--surface);
    border: 1px solid var(--border);
}

.msg .bg-light.rounded {
    background: var(--surface) !important;
    border: 1px solid var(--border);
    border-radius: 12px;
}

/* Ø§Ù„ØªÙƒÙŠÙ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
@media (max-width: 768px) {
    .chat-container {
        flex-direction: column;
        height: 100vh;
        border-radius: 0;
        margin: 0;
    }

    .chat-sidebar {
        width: 100%;
        height: 40%;
    }

    .chat-messages {
        height: 60%;
    }

    .msg {
        max-width: 85%;
    }

    .chat-input {
        padding: 10px 15px;
    }

    #emptyState {
        font-size: 2rem;
    }

    .chat-file {
        max-width: 250px;
        padding: 10px;
    }

    .file-details {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }

    .msg a.btn-outline-secondary,
    .msg a.btn-sm {
        padding: 4px 8px;
        font-size: 0.7rem;
    }
}

/* ÙØ¦Ø§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ© */
.text-muted {
    color: var(--text-secondary) !important;
}

.border {
    border-color: var(--border) !important;
}

.bg-light {
    background-color: var(--background) !important;
}

.shadow-sm {
    box-shadow: 0 2px 4px var(--shadow) !important;
}


/* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² */
#messageInput:focus {
    border-color: var(--primary-light);
    box-shadow: 0 0 0 3px var(--shadow);
}

/* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
#sendBtn:not(:disabled) {
    cursor: pointer;
}

#sendBtn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.msg.deleted-text .msg-content {
    background: #f1f5f9;
    color: #6b7280;
    font-style: italic;
}











============================================================

using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.SignalR;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;
using Tawasul.Data;
using Tawasul.Hubs;
using Tawasul.Models;
using Tawasul.Models.ViewModels;

namespace Tawasul.Controllers
{
    [Authorize]
    public class ChatController : Controller
    {
        private readonly TawasulDbContext _db;
        private readonly UserManager<ApplicationUser> _userManager;
        private readonly IHubContext<ChatHub> _hubContext;

        public ChatController(
            TawasulDbContext db,
            UserManager<ApplicationUser> userManager,
            IHubContext<ChatHub> hubContext)
        {
            _db = db;
            _userManager = userManager;
            _hubContext = hubContext;
        }

        public async Task<IActionResult> Index()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (userId == null)
                return RedirectToAction("Login", "Account");

            // Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø³ÙŠØªØ­ÙˆÙ„ Ø¥Ù„Ù‰ SQL ÙˆØ§Ø­Ø¯ Ø³Ø±ÙŠØ¹
            var conversations = await _db.ConversationMembers
                .Where(cm => cm.UserId == userId)
                .Select(cm => new ConversationListViewModel
                {
                    ConversationId = cm.ConversationId,
                    Type = cm.Conversation.Type == ConversationType.Group ? "Group" : "Chat",


                    // ğŸŸ¦ ÙŠØ¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµØ­ÙŠØ­
                    DisplayTitle = (cm.Conversation.Type == ConversationType.Group)
                        ? cm.Conversation.Title ?? "(Ù…Ø¬Ù…ÙˆØ¹Ø©)"
                        : cm.Conversation.Members
                              .Where(m => m.UserId != userId)
                              .Select(m => m.User.DisplayName ?? m.User.Email)
                              .FirstOrDefault() ?? "(Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ)",

                    // ğŸŸ¦ ÙŠØ¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
                    PhotoUrl = (cm.Conversation.Type == ConversationType.Group)
                        ? null
                        : cm.Conversation.Members
                              .Where(m => m.UserId != userId)
                              .Select(m => m.User.PhotoUrl)
                              .FirstOrDefault(),

                    // ğŸŸ¢ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (IsOnline)
                    IsOnline = (cm.Conversation.Type == ConversationType.Group)
                        ? false
                        : cm.Conversation.Members
                              .Where(m => m.UserId != userId)
                              .Select(m => m.User.IsOnline)
                              .FirstOrDefault(),

                    // â° Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±
                    LastSeenAt = (cm.Conversation.Type == ConversationType.Group)
                        ? null
                        : cm.Conversation.Members
                              .Where(m => m.UserId != userId)
                              .Select(m => m.User.LastSeenAt.HasValue
                                  ? (DateTime?)m.User.LastSeenAt.Value.UtcDateTime
                                  : (DateTime?)null)
                              .FirstOrDefault(),

                    // ğŸ“¨ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
                    LastMessage = cm.Conversation.Messages
                        .OrderByDescending(m => m.CreatedAtUtc)
                        .Select(m => m.Text)
                        .FirstOrDefault(),

                    // ğŸ•’ ÙˆÙ‚Øª Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
                    LastMessageTime = cm.Conversation.Messages
                        .OrderByDescending(m => m.CreatedAtUtc)
                        .Select(m => m.CreatedAtUtc)
                        .FirstOrDefault(),

                    // ğŸ”µ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
                    UnreadCount = _db.UserMessageStatuses
                        .Count(ums =>
                            ums.ConversationId == cm.ConversationId &&
                            ums.UserId == userId &&
                            ums.HasSeen == false)
                })
                .OrderByDescending(c => c.LastMessageTime)
                .ToListAsync();

            ViewBag.OpenConversationId = Request.Query["open"].ToString();

            return View(conversations);
        }


        [HttpGet("Chat/LoadMessages/{id}")]
        public async Task<IActionResult> LoadMessages(long id)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (userId == null) return Unauthorized();

            // âœ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
            await _db.UserMessageStatuses
                .Where(ums => ums.ConversationId == id &&
                              ums.UserId == userId &&
                              ums.HasSeen == false)
                .ExecuteUpdateAsync(updates =>
                    updates.SetProperty(ums => ums.HasSeen, true)
                           .SetProperty(ums => ums.SeenAtUtc, DateTime.UtcNow));

            // âœ… Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØºÙŠØ± Ù…Ø­Ø°ÙˆÙØ© ÙÙ‚Ø·
            var messages = await _db.Messages
                .Include(m => m.Sender)
                .Include(m => m.Attachments)
                .Where(m => m.ConversationId == id && !m.IsDeleted) // â¬…ï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§
                .OrderBy(m => m.CreatedAtUtc)
                .Select(m => new
                {
                    m.Id,
                    m.Text,
                    m.CreatedAtUtc,
                    m.IsDeleted,
                    m.IsEdited,
                    m.ConversationId,
                    IsMine = (m.SenderId == userId),
                    Sender = m.Sender.DisplayName ?? m.Sender.UserName,
                    PhotoUrl = m.Sender.PhotoUrl,

                    // Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
                    FileUrl = m.Attachments.Any()
                        ? m.Attachments.First().FilePath
                        : null,
                    FileType = m.Attachments.Any()
                        ? m.Attachments.First().ContentType
                        : null,
                    FileName = m.Attachments.Any()
                        ? m.Attachments.First().OriginalName
                        : null,
                    FileSize = m.Attachments.Any()
                        ? m.Attachments.First().SizeBytes
                        : 0
                })
                .ToListAsync();

            return Json(messages);
        }



        [HttpPost]
        public async Task<IActionResult> SendMessage(long conversationId, string? text, IFormFile? file)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (userId == null)
                return Unauthorized();

            // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† Ù†Øµ
            if (string.IsNullOrWhiteSpace(text) && file == null)
                return BadRequest("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„.");

            var sender = await _userManager.FindByIdAsync(userId);
            if (sender == null)
                return Unauthorized();

            // ğŸŸ¦ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            var message = new Message
            {
                ConversationId = conversationId,
                SenderId = userId,
                Text = string.IsNullOrWhiteSpace(text) ? null : text.Trim(), // âœ… null Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ
                CreatedAtUtc = DateTime.UtcNow
            };

            _db.Messages.Add(message);
            await _db.SaveChangesAsync();

            // ğŸŸ¦ Ù„Ùˆ ÙÙŠ Ù…Ù„Ù Ù…Ø±ÙÙ‚
            MessageAttachment? attachment = null;
            if (file != null && file.Length > 0)
            {
                // âœ… 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ù… (Ù…Ø«Ù„Ø§Ù‹ 25 Ù…ÙŠØ¬Ø§)
                const long maxFileSize = 25 * 1024 * 1024;
                if (file.Length > maxFileSize)
                    return BadRequest("Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ (25MB).");

                // âœ… 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§
                var allowedPrefixes = new[]
                {
            "image/", "video/", "audio/",
            "application/pdf",
            "application/zip",
            "application/msword",
            "application/vnd.openxmlformats-officedocument"
        };

                bool isAllowed = allowedPrefixes.Any(p => file.ContentType.StartsWith(p, StringComparison.OrdinalIgnoreCase));
                if (!isAllowed)
                    return BadRequest($"Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…: {file.ContentType}");

                // âœ… 3. Ù…Ø³Ø§Ø± Ø§Ù„Ø­ÙØ¸
                var uploadsPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "chat");
                Directory.CreateDirectory(uploadsPath);

                // âœ… 4. Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ø³Ù… ÙØ±ÙŠØ¯
                var uniqueName = $"{Guid.NewGuid()}{Path.GetExtension(file.FileName)}";
                var filePath = Path.Combine(uploadsPath, uniqueName);

                using (var stream = new FileStream(filePath, FileMode.Create))
                {
                    await file.CopyToAsync(stream);
                }

                // âœ… 5. Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                attachment = new MessageAttachment
                {
                    MessageId = message.Id,
                    FilePath = $"/uploads/chat/{uniqueName}",
                    ContentType = file.ContentType,
                    SizeBytes = file.Length,
                    OriginalName = file.FileName
                };

                _db.Add(attachment);
                await _db.SaveChangesAsync();
            }

            // ğŸŸ© ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ù„ØªØ±Ø³Ù„ Ø¹Ø¨Ø± SignalR ÙˆØ§Ù„Ù€ JSON)
            var msgResponse = new
            {
                message.Id,
                message.Text,
                message.CreatedAtUtc,
                message.ConversationId,
                message.SenderId,
                IsMine = true,
                FileUrl = attachment?.FilePath,
                FileType = attachment?.ContentType,
                FileName = attachment?.OriginalName,
                FileSize = attachment?.SizeBytes
            };

            // ğŸŸ¨ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ØºØ±ÙØ©
            var broadcastModel = new
            {
                message.Id,
                message.Text,
                message.CreatedAtUtc,
                message.ConversationId,
                message.SenderId,
                IsMine = false,
                FileUrl = attachment?.FilePath,
                FileType = attachment?.ContentType,
                FileName = attachment?.OriginalName,
                FileSize = attachment?.SizeBytes
            };

            await _hubContext.Clients.Group(conversationId.ToString())
                .SendAsync("ReceiveMessage", broadcastModel);

            return Json(msgResponse);
        }

        // ... (Ø¯Ø§Ø®Ù„ ChatController)

        // âœ… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„Ù„Ø§Ø¶Ø§ÙØ©)
        [HttpGet]
        public async Task<IActionResult> SearchUsers(string query)
        {
            var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrWhiteSpace(query))
                return Json(new List<object>()); // Ø£Ø¹Ø¯ Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©

            // Ø¬Ø¹Ù„ Ø§Ù„Ø¨Ø­Ø« (Case-Insensitive)
            var normalizedQuery = query.ToUpper().Trim();

            var users = await _db.Users
                .Where(u => u.Id != currentUserId && // Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡
                            (u.NormalizedEmail.Contains(normalizedQuery) ||
                             u.PhoneNumber.Contains(query))) // Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø§ ÙŠØ­ØªØ§Ø¬ (Normalized)
                .Select(u => new
                {
                    // Ù†Ø±Ø³Ù„ ÙÙ‚Ø· Ù…Ø§ Ù†Ø­ØªØ§Ø¬Ù‡ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
                    u.Id,
                    u.DisplayName,
                    u.PhotoUrl,
                    u.Email
                })
                .Take(5) // Ø­Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ù€ 5 ÙÙ‚Ø·
                .ToListAsync();

            return Json(users);
        }


        // ... (Ø¯Ø§Ø®Ù„ ChatController.cs)

        // âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©)
        [HttpPost]
        public async Task<IActionResult> StartChat(string targetUserId)
        {
            var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(targetUserId) || currentUserId == targetUserId)
                return BadRequest();

            // 1. Ù‡Ù„ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø© (Type 0) Ø¨ÙŠÙ†Ù‡Ù…Ø§ Ù…Ù† Ù‚Ø¨Ù„ØŸ
            // ğŸ”½ğŸ”½ (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) ğŸ”½ğŸ”½
            var existingConversation = await _db.Conversations
                .Include(c => c.Members) // â¬…ï¸ (1) Ø£Ø¶ÙÙ†Ø§ Include
                .Where(c => c.Type == ConversationType.Direct && // â¬…ï¸ (2) Ù‚Ø§Ø±Ù†Ø§ Ø¨Ù€ Enum
                            c.Members.Any(m => m.UserId == currentUserId) &&
                            c.Members.Any(m => m.UserId == targetUserId))
                .FirstOrDefaultAsync();
            // ğŸ”¼ğŸ”¼ (Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) ğŸ”¼ğŸ”¼

            if (existingConversation != null)
            {
                // 2. Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©: Ø£Ø¹Ø¯ Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡Ø§
                return Json(new { conversationId = existingConversation.Id });
            }

            // 3. Ø¥Ø°Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©: Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
            var conversation = new Conversation
            {
                Type = ConversationType.Direct, // â¬…ï¸ (3) Ø§Ø³ØªØ®Ø¯Ù… Enum Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹
                CreatedByUserId = currentUserId!,
                CreatedAtUtc = DateTime.UtcNow
            };

            // 4. Ø£Ø¶Ù Ø§Ù„Ø¹Ø¶ÙˆÙŠÙ†
            var members = new List<ConversationMember>
    {
        new ConversationMember { UserId = currentUserId!, JoinedAtUtc = DateTime.UtcNow },
        new ConversationMember { UserId = targetUserId, JoinedAtUtc = DateTime.UtcNow }
    };

            conversation.Members = members;

            _db.Conversations.Add(conversation);
            await _db.SaveChangesAsync();

            // 5. Ø£Ø¹Ø¯ Ø§Ù„Ù€ ID Ø§Ù„Ø¬Ø¯ÙŠØ¯
            return Json(new { conversationId = conversation.Id });
        }



        [HttpPost]
        public async Task<IActionResult> EditMessage(long messageId, string newText)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (userId == null) return Unauthorized();

            var msg = await _db.Messages.FirstOrDefaultAsync(m => m.Id == messageId && !m.IsDeleted);
            if (msg == null) return NotFound("Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
            if (msg.SenderId != userId) return Forbid();

            msg.Text = newText.Trim();
            msg.IsEdited = true;
            await _db.SaveChangesAsync();

            // Ø¨Ø« Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            await _hubContext.Clients.Group(msg.ConversationId.ToString())
                .SendAsync("MessageEdited", new
                {
                    msg.Id,
                    msg.ConversationId,
                    msg.Text,
                    msg.IsEdited
                });

            return Ok();
        }



        [HttpPost]
        public async Task<IActionResult> DeleteMessage(long messageId, bool deleteForAll = false)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (userId == null) return Unauthorized();

            var msg = await _db.Messages
                .Include(m => m.Attachments) // â¬…ï¸ Ù…Ù‡Ù…: ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
                .FirstOrDefaultAsync(m => m.Id == messageId);

            if (msg == null) return NotFound();

            // ğŸ”¹ Ø¥Ø°Ø§ Ø­Ø°Ù Ù„Ù„Ø¬Ù…ÙŠØ¹
            if (deleteForAll)
            {
                if (msg.SenderId != userId) return Forbid();

                // ğŸ”¥ Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø­Ø°Ù ÙØ¹Ù„ÙŠ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (msg.Attachments != null && msg.Attachments.Any())
                {
                    // ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                    foreach (var attachment in msg.Attachments)
                    {
                        var filePath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", attachment.FilePath.TrimStart('/'));
                        if (System.IO.File.Exists(filePath))
                        {
                            System.IO.File.Delete(filePath);
                        }
                    }

                    // ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    _db.MessageAttachments.RemoveRange(msg.Attachments);
                }

                // ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù†ÙØ³Ù‡Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                _db.Messages.Remove(msg);

                await _db.SaveChangesAsync();

                // ğŸ“¢ Ø¨Ø« Ø¹Ø¨Ø± SignalR Ù„Ù„Ø­Ø°Ù Ø§Ù„ÙƒØ§Ù…Ù„
                await _hubContext.Clients.Group(msg.ConversationId.ToString())
                    .SendAsync("MessageDeleted", new
                    {
                        msg.Id,
                        msg.ConversationId,
                        deletedCompletely = true // â¬…ï¸ Ø¥Ø´Ø§Ø±Ø© Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø­Ø°ÙØª ÙƒÙ„ÙŠØ§Ù‹
                    });
            }
            else
            {
                // ğŸ”¹ Ø­Ø°Ù Ù…Ù† Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· (client-side)
                await _hubContext.Clients.User(userId)
                    .SendAsync("MessageDeleted", new
                    {
                        msg.Id,
                        msg.ConversationId,
                        deletedCompletely = false
                    });
            }

            return Ok();
        }


    }
}
