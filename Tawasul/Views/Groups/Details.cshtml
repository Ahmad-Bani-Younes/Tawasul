@model Tawasul.Models.ViewModels.GroupDetailsViewModel
@{
    ViewData["Title"] = "إدارة المجموعة";
    Layout = "_Layout";

    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var currentMember = Model.Members.FirstOrDefault(m => m.UserId == currentUserId);
    bool isOwner = Model.IsOwner;
    bool isAdmin = currentMember?.IsAdmin == true;
}

<div class="container mt-4">
    <div class="card shadow-sm mb-3">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h4 class="card-title mb-0">@Model.Title</h4>
                <small class="text-muted">أنشأها: @Model.CreatorName</small><br />
                <small class="text-secondary">بتاريخ: @Model.CreatedAtUtc.ToLocalTime().ToString("dd/MM/yyyy hh:mm tt")</small>
            </div>

            <button class="btn btn-primary" id="btnAddMember">➕ إضافة عضو</button>

        </div>
    </div>

    <h5 class="mb-3">الأعضاء (@Model.Members.Count)</h5>

    <table class="table align-middle table-hover bg-white shadow-sm">
        <thead class="table-light">
            <tr>
                <th>الصورة</th>
                <th>الاسم</th>
                <th>الدور</th>
                <th>أضيف بواسطة</th>
                <th>التحكم</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var m in Model.Members)
            {
                bool canControl = false;

                if (isOwner)
                {
                    // المالك يقدر يتحكم بأي عضو (حتى الأدمن)
                    canControl = !m.IsOwner;
                }
                else if (isAdmin)
                {
                    // الأدمن يتحكم فقط بالأعضاء العاديين
                    canControl = !m.IsOwner && !m.IsAdmin;
                }

                <tr data-id="@m.UserId">
                    <td>
                        <img src="@(m.PhotoUrl ?? "/images/default-avatar.png")" class="rounded-circle" width="40" height="40" />
                    </td>

                    <td>@m.DisplayName</td>

                    <td>
                        @if (m.IsOwner)
                        {
                            <span class="badge bg-primary">المالك</span>
                        }
                        else if (m.IsAdmin)
                        {
                            <span class="badge bg-success">أدمن</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">عضو</span>
                        }

                        @if (m.IsMuted)
                        {
                            <span class="badge bg-warning text-dark ms-1">مكتوم</span>
                        }
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(m.InvitedByName))
                        {
                            <small class="text-muted">@m.InvitedByName</small>
                        }
                        else
                        {
                            <small class="text-muted">—</small>
                        }
                    </td>


                    <td>
                        @if (canControl)
                        {
                            <div class="btn-group">
                                @if (isOwner)
                                {
                                    <button class="btn btn-sm btn-outline-success btnToggleAdmin">
                                        @(m.IsAdmin ? "إلغاء أدمن" : "ترقية لأدمن")
                                    </button>
                                }

                                @if (m.IsMuted)
                                {
                                    <button class="btn btn-sm btn-outline-info btnUnmute">🔈 فك الكتم</button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-warning btnMute">🔇 كتم</button>
                                }

                                <button class="btn btn-sm btn-outline-danger btnRemove">🗑️ إزالة</button>
                            </div>
                        }
                        else
                        {
                            <span class="text-muted small">—</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (isOwner || isAdmin)
{
    <hr class="my-4" />
    <h5 class="mb-3">طلبات الانضمام المعلقة</h5>

    <div id="joinRequestsSection" class="bg-light p-3 rounded shadow-sm">
        <div id="joinRequestsList" class="text-center text-muted">جارِ التحميل...</div>
    </div>
}


<!-- 🔹 نافذة إضافة عضو -->
<div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">إضافة عضو جديد</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input id="searchUserInput" class="form-control" placeholder="ابحث بالبريد أو رقم الهاتف..." />
                <div id="searchUserResults" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- 🔇 نافذة كتم العضو -->
<div class="modal fade" id="muteMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">🔇 كتم العضو</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">اختر مدة الكتم:</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-secondary btnMuteDuration" data-hours="1">⏱ ساعة واحدة</button>
                    <button class="btn btn-outline-secondary btnMuteDuration" data-hours="24">📅 يوم واحد</button>
                    <button class="btn btn-outline-secondary btnMuteDuration" data-hours="168">🗓 أسبوع واحد</button>
                    <div class="input-group mt-2">
                        <input type="number" id="customMuteHours" class="form-control" placeholder="عدد الساعات" min="1" />
                        <button class="btn btn-outline-primary" id="btnCustomMute">تأكيد</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const groupId = @Model.Id;
    let selectedUserId = null;

    $("#btnAddMember").click(() => $("#addMemberModal").modal("show"));

        // ✅ البحث
    $("#searchUserInput").on("keyup", function () {
        const q = $(this).val().trim();
        if (q.length < 2) return $("#searchUserResults").empty();

        // 🔽🔽 (هذا هو التعديل) 🔽🔽
        //  قمنا بحذف سطر 'culture' واستخدام المسار الصحيح
        $.get(`/GroupMembers/Search`, { query: q, groupId: groupId }, users => {
        // 🔼🔼 (انتهى التعديل) 🔼🔼

            const box = $("#searchUserResults");
            box.empty();

            if (users.length === 0) {
                box.html('<div class="text-muted text-center">لا يوجد نتائج</div>');
                return;
            }

            users.forEach(u => {
                box.append(`
                    <div class="d-flex align-items-center justify-content-between p-2 border rounded mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <img src="${u.photoUrl ?? '/images/default-avatar.png'}" width="35" height="35" class="rounded-circle" />
                            <div>
                                <strong>${u.displayName}</strong><br/>
                                <small class="text-muted">${u.email}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary btnAddUser" data-id="${u.id}">➕ إضافة</button>
                    </div>
                `);
            });
        });
    });

    // ✅ إضافة عضو
    $(document).on("click", ".btnAddUser", function () {
        const userId = $(this).data("id");
        $.post("/GroupMembers/AddMember", { groupId, userId })
            .done(() => { alert("✅ تمت إضافة العضو بنجاح!"); location.reload(); })
            .fail(() => alert("❌ حدث خطأ أثناء الإضافة."));
    });

    // ✅ إزالة
    $(document).on("click", ".btnRemove", function () {
        const userId = $(this).closest("tr").data("id");
        if (!confirm("هل أنت متأكد من إزالة هذا العضو؟")) return;
        $.post("/GroupMembers/RemoveMember", { groupId, userId })
            .done(() => location.reload())
            .fail(() => alert("❌ لا تملك صلاحية إزالة هذا العضو."));
    });

    // ✅ ترقية / إلغاء أدمن
    $(document).on("click", ".btnToggleAdmin", function () {
        const userId = $(this).closest("tr").data("id");
        $.post("/GroupMembers/ToggleAdmin", { groupId, userId })
            .done(() => location.reload())
            .fail(() => alert("❌ لا تملك صلاحية تنفيذ هذا الإجراء."));
    });

    // ✅ كتم / فك الكتم
    $(document).on("click", ".btnMute", function () {
        selectedUserId = $(this).closest("tr").data("id");
        $("#muteMemberModal").modal("show");
    });

    $(document).on("click", ".btnMuteDuration", function () {
        muteMember($(this).data("hours"));
    });

    $("#btnCustomMute").click(() => {
        const hours = parseInt($("#customMuteHours").val());
        if (!hours || hours <= 0) { alert("الرجاء إدخال عدد ساعات صحيح."); return; }
        muteMember(hours);
    });

    function muteMember(hours) {
        if (!selectedUserId) return;
        $.post("/GroupMembers/MuteMember", { groupId, userId: selectedUserId, hours })
            .done(() => { $("#muteMemberModal").modal("hide"); alert("✅ تم كتم العضو بنجاح!"); location.reload(); })
            .fail(() => alert("❌ لا تملك صلاحية كتم هذا العضو."));
    }

    $(document).on("click", ".btnUnmute", function () {
        const userId = $(this).closest("tr").data("id");
        $.post("/GroupMembers/UnmuteMember", { groupId, userId })
            .done(() => { alert("🔈 تم فك الكتم بنجاح!"); location.reload(); })
            .fail(() => alert("❌ لا تملك صلاحية فك الكتم عن هذا العضو."));
    });
</script>
<script>
    // ✅ تحميل الطلبات عند فتح الصفحة (للأدمن والمالك فقط)
    $(document).ready(function () {
        loadJoinRequests();
    });

    function loadJoinRequests() {
        const section = $("#joinRequestsList");
        if (section.length === 0) return; // المستخدم مش أدمن أو مالك

        $.get(`/GroupJoinRequests/GetPending?groupId=${groupId}`, requests => {
            if (requests.length === 0) {
                section.html('<div class="text-muted">لا يوجد طلبات حالياً</div>');
                return;
            }

            section.empty();
            requests.forEach(r => {
                section.append(`
                    <div class="d-flex align-items-center justify-content-between border rounded p-2 mb-2 bg-white">
                        <div>
                            <img src="${r.photoUrl ?? '/images/default-avatar.png'}" width="35" height="35" class="rounded-circle me-2" />
                            <strong>${r.displayName}</strong>
                            <small class="text-muted d-block">${r.email}</small>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success btnApprove" data-id="${r.id}">✅ قبول</button>
                            <button class="btn btn-sm btn-danger btnReject" data-id="${r.id}">❌ رفض</button>
                        </div>
                    </div>
                `);
            });
        });
    }

    // ✅ قبول طلب
    $(document).on("click", ".btnApprove", function () {
        const id = $(this).data("id");
        $.post(`/GroupJoinRequests/Approve`, { id })
            .done(() => { alert("تم قبول الطلب ✅"); loadJoinRequests(); location.reload(); })
            .fail(() => alert("حدث خطأ أثناء القبول ❌"));
    });

    // ✅ رفض طلب
    $(document).on("click", ".btnReject", function () {
        const id = $(this).data("id");
        $.post(`/GroupJoinRequests/Reject`, { id })
            .done(() => { alert("تم رفض الطلب ❌"); loadJoinRequests(); })
            .fail(() => alert("حدث خطأ أثناء الرفض ❌"));
    });
</script>
