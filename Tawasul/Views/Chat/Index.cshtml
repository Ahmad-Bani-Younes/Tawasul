@model List<Tawasul.Models.ViewModels.ConversationListViewModel>
@{
    ViewData["Title"] = "المحادثات";
    Layout = "_Layout";

    var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
<style>
    body {
        background: #f8fafc;
        font-family: 'Tajawal', sans-serif;
    }

    .chat-container {
        display: flex;
        height: calc(100vh - 100px);
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        overflow: hidden;
    }

    .chat-sidebar {
        width: 30%;
        background: #fff;
        border-inline-end: 1px solid #e5e7eb;
        overflow-y: auto;
    }

        .chat-sidebar .conv-item {
            padding: 12px 14px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: .2s;
        }

            .chat-sidebar .conv-item:hover {
                background: #f1f5f9;
            }

        .chat-sidebar .active {
            background: #e0f2fe;
        }

    .chat-messages {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #f9fafb;
    }

    .chat-body {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
    }

    .msg {
        margin: 6px 0;
        padding: 10px 14px;
        border-radius: 16px;
        max-width: 70%;
        word-wrap: break-word;
    }

        .msg.me {
            background: #2563eb;
            color: #fff;
            margin-inline-start: auto;
        }

        .msg.other {
            background: #e5e7eb;
            color: #111827;
            margin-inline-end: auto;
        }

    .chat-input {
        display: flex;
        border-top: 1px solid #ddd;
        background: #fff;
    }

        .chat-input input {
            flex: 1;
            border: none;
            padding: 14px;
            outline: none;
        }

        .chat-input button {
            background: #2563eb;
            color: #fff;
            border: none;
            padding: 0 20px;
            font-weight: 600;
        }

    .nav-tabs .nav-link {
        border: none;
        background: none;
        font-weight: 600;
        color: #6b7280;
    }

        .nav-tabs .nav-link.active {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
        }

    #chatHeader {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        background: #fff;
    }

        #chatHeader .info-btn {
            border: none;
            background: transparent;
            font-size: 18px;
            cursor: pointer;
            color: #555;
        }

            #chatHeader .info-btn:hover {
                color: #000;
            }
</style>

<div class="container mt-4">
    <div class="chat-container shadow-sm">

        <!-- 🔹 الشريط الجانبي -->
        <div class="chat-sidebar">
            <ul class="nav nav-tabs nav-fill border-bottom" id="chatTabs">
                <li class="nav-item">
                    <button class="nav-link active" id="tab-chats">💬 المحادثات</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="tab-groups">👥 المجموعات</button>
                </li>
            </ul>

            <div class="p-3 border-bottom">
                <input type="text" id="userSearchInput" class="form-control" placeholder="ابحث بالإيميل أو رقم الهاتف..." />
                <div id="userSearchResults" class="mt-2"></div>
            </div>

            <!-- قائمة المحادثات -->
            <div id="chatList">
                @foreach (var c in Model.Where(x => x.Type == "Chat"))
                {
                    <div class="conv-item d-flex align-items-center gap-2"
                         data-id="@c.ConversationId" data-type="chat">
                        <img src="@(string.IsNullOrEmpty(c.PhotoUrl) ? "/images/default-avatar.png" : c.PhotoUrl)"
                             class="rounded-circle flex-shrink-0" width="42" height="42" />
                        <div class="flex-grow-1">
                            <div class="fw-bold">@c.DisplayTitle</div>
                            <div class="text-muted small">@c.LastMessage</div>
                        </div>
                    </div>
                }
            </div>

            <!-- إنشاء مجموعة جديدة -->
            <div class="p-3 border-bottom text-center" id="createGroupBox" style="display:none;">
                <button class="btn btn-primary w-100" id="btnNewGroup">➕ إنشاء مجموعة جديدة</button>
            </div>

            <!-- قائمة المجموعات -->
            <div id="groupList" class="d-none">
                @foreach (var g in Model.Where(x => x.Type == "Group"))
                {
                    <div class="conv-item d-flex align-items-center gap-2"
                         data-id="@g.ConversationId" data-type="group">
                        <img src="@(string.IsNullOrEmpty(g.PhotoUrl) ? "/images/group-avatar.png" : g.PhotoUrl)"
                             class="rounded-circle flex-shrink-0" width="42" height="42" />
                        <div class="flex-grow-1">
                            <div class="fw-bold">@g.DisplayTitle</div>
                            <div class="text-muted small">@g.LastMessage</div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- 🔹 منطقة الرسائل -->
        <div class="chat-messages">
            <div id="chatHeader" style="display:none;">
                <div class="d-flex align-items-center gap-2">
                    <img id="chatHeaderPhoto" src="/images/default-avatar.png" width="42" height="42" class="rounded-circle" />
                    <div>
                        <div id="chatHeaderName" class="fw-bold"></div>
                    </div>
                </div>
                <button id="btnGroupInfo" class="info-btn d-none" title="تفاصيل المجموعة">ℹ️</button>
            </div>

            <div id="chatBody" class="chat-body">
                <div class="text-center text-muted mt-5">اختر محادثة أو مجموعة لعرض الرسائل</div>
            </div>

            <div class="chat-input" id="chatInputArea">
                <input id="messageInput" type="text" placeholder="اكتب رسالتك..." disabled />
                <button id="sendBtn" disabled>إرسال</button>
            </div>
        </div>
    </div>

    <!-- نافذة إنشاء مجموعة جديدة -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إنشاء مجموعة جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="groupNameInput" class="form-control" placeholder="أدخل اسم المجموعة..." />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveGroupBtn">إنشاء</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 🧩 سكربت -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let currentConvId = null;
    let currentType = null;



        // ✅ إذا تم تمرير open ID في الرابط، نحاول فتحها تلقائياً
    $(document).ready(() => {
        const params = new URLSearchParams(window.location.search);
        const openId = params.get("open");
        if (openId) {
            $(`.conv-item[data-id='${openId}']`).trigger("click");
        }
    });


    // ✅ عند الضغط على محادثة أو مجموعة
    $(document).on("click", ".conv-item", function () {
        $(".conv-item").removeClass("active");
        $(this).addClass("active");

        const id = $(this).data("id");
        const type = $(this).data("type");
        currentConvId = id;
        currentType = type;

        const name = $(this).find(".fw-bold:first").text().trim();
        const photo = $(this).find("img").attr("src") || "/images/default-avatar.png";

        $("#chatHeaderPhoto").attr("src", photo);
        $("#chatHeaderName").text(name);
        $("#chatHeader").show();

        if (type === "group") {
            $("#btnGroupInfo").removeClass("d-none").data("group-id", id);
        } else {
            $("#btnGroupInfo").addClass("d-none");
        }

        $("#chatBody").html('<div class="text-center text-muted mt-5">جارٍ تحميل الرسائل...</div>');
        $("#messageInput, #sendBtn").prop("disabled", false);

        $.get(`/Chat/LoadMessages/${id}`, function (data) {
            $("#chatBody").empty();
            data.forEach(m => appendMessage(m));
        });
    });

    // ✅ زر معلومات المجموعة
    $("#btnGroupInfo").on("click", function () {
        const id = $(this).data("group-id");
        if (id) window.location.href = `/Groups/Details/${id}`;
    });

    // ✅ إرسال الرسائل
    $("#sendBtn").click(sendMessage);
    $("#messageInput").keypress(e => { if (e.which === 13) sendMessage(); });

    function sendMessage() {
        const text = $("#messageInput").val().trim();
        if (!text || !currentConvId) return;
        $.post("/Chat/SendMessage", { conversationId: currentConvId, text }, msg => {
            appendMessage(msg);
            $("#messageInput").val("");
        });
    }

    function appendMessage(m) {
        const html = `
            <div class="msg ${m.isMine ? "me" : "other"}">
                <div>${m.text}</div>
                <div class="small mt-1 text-end opacity-75">
                    ${new Date(m.createdAtUtc).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
            </div>`;
        $("#chatBody").append(html);
    }

    // ✅ التبديل بين المحادثات والمجموعات
    $("#tab-chats").click(() => {
        $("#tab-chats").addClass("active");
        $("#tab-groups").removeClass("active");
        $("#chatList").removeClass("d-none");
        $("#groupList").addClass("d-none");
        $("#createGroupBox").hide();
        $("#userSearchInput").attr("placeholder", "ابحث بالإيميل أو رقم الهاتف...");
    });

    $("#tab-groups").click(() => {
        $("#tab-groups").addClass("active");
        $("#tab-chats").removeClass("active");
        $("#groupList").removeClass("d-none");
        $("#chatList").addClass("d-none");
        $("#createGroupBox").show();
        $("#userSearchInput").attr("placeholder", "ابحث باسم المجموعة...");
    });

    // ✅ إنشاء المجموعة
    $("#btnNewGroup").click(() => $("#createGroupModal").modal("show"));
    $("#saveGroupBtn").click(() => {
        let title = $("#groupNameInput").val().trim();
        if (!title) return alert("الرجاء إدخال اسم المجموعة.");
        $.post("/Groups/Create", { title }, () => location.reload())
         .fail(() => alert("حدث خطأ أثناء إنشاء المجموعة."));
    });




        $("#userSearchInput").on("keyup", function () {
        const q = $(this).val().trim();
        if (q.length < 2) return $("#userSearchResults").empty();

       const url = `/Chat/SearchUsers`;


        $.get(url, { query: q }, users => {
            const box = $("#userSearchResults");
            box.empty();

            if (users.length === 0) {
                box.html('<div class="text-muted text-center">لا يوجد نتائج</div>');
                return;
            }

            users.forEach(u => {
                box.append(`
                    <div class="d-flex align-items-center justify-content-between p-2 border rounded mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <img src="${u.photoUrl ?? '/images/default-avatar.png'}" width="35" height="35" class="rounded-circle" />
                            <div>
                                <strong>${u.displayName ?? "(مستخدم غير معروف)"}</strong><br/>
                                <small class="text-muted">${u.email ?? ""}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary btnStartChat" data-id="${u.id}">بدء محادثة</button>
                    </div>
                `);
            });
        });
    });


        // ✅ عند الضغط على "بدء محادثة"
    $(document).on("click", ".btnStartChat", function () {
        const targetUserId = $(this).data("id");

        $.post("/Chat/StartChat", { targetUserId }, res => {
            if (res.conversationId) {
                // نعيد تحميل الصفحة ونفتح المحادثة الجديدة
                location.href = `/Chat?open=${res.conversationId}`;
            } else {
                alert("حدث خطأ أثناء إنشاء المحادثة.");
            }
        }).fail(() => {
            alert("حدث خطأ أثناء محاولة بدء المحادثة.");
        });
    });


</script>
