@model List<Tawasul.Models.ViewModels.ConversationListViewModel>
@inject Microsoft.AspNetCore.Identity.UserManager<Tawasul.Models.ApplicationUser> UserManager
@{
    ViewData["Title"] = "المحادثات";
    Layout = "_Layout";

    var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var currentUser = await UserManager.GetUserAsync(User);
    var displayName = currentUser?.DisplayName ?? currentUser?.Email ?? "مستخدم";
}
<link rel="stylesheet" href="~/css/IndexChat.css" asp-append-version="true" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<!-- Fabric.js للرسم والكتابة على الصور -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>


<div class="container mt-4">
    <div class="chat-container shadow-sm">

        <!-- 🔹 الشريط الجانبي -->
        <div class="chat-sidebar">
            <ul class="nav nav-tabs nav-fill border-bottom" id="chatTabs">
                <li class="nav-item">
                    <button class="nav-link active" id="tab-chats">💬 المحادثات</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="tab-groups">👥 المجموعات</button>
                </li>
            </ul>

            <div class="p-3 border-bottom">
                <input type="text" id="userSearchInput" class="form-control" placeholder="ابحث بالإيميل أو رقم الهاتف..." />
                <div id="userSearchResults" class="mt-2"></div>
            </div>

            <!-- قائمة المحادثات -->
            <div id="chatList">
                @foreach (var c in Model.Where(x => x.Type == "Chat"))
                {
                    <div class="conv-item d-flex align-items-center gap-2"
                         data-id="@c.ConversationId" data-type="chat">
                        <img src="@(string.IsNullOrEmpty(c.PhotoUrl) ? "/images/default-avatar.png" : c.PhotoUrl)"
                             class="rounded-circle flex-shrink-0" width="42" height="42" />
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="fw-bold">@c.DisplayTitle</div>
                                @if (c.UnreadCount > 0)
                                {
                                    <span class="badge bg-primary rounded-pill badge-unread">@c.UnreadCount</span>
                                }
                            </div>
                            <div class="text-muted small">@c.LastMessage</div>
                        </div>
                    </div>
                }
            </div>


            <!-- إنشاء مجموعة جديدة -->
            <div class="p-3 border-bottom text-center" id="createGroupBox" style="display:none;">
                <button class="btn btn-primary w-100" id="btnNewGroup">➕ إنشاء مجموعة جديدة</button>
            </div>

            <!-- قائمة المجموعات -->
            <div id="groupList" class="d-none">
                @foreach (var g in Model.Where(x => x.Type == "Group"))
                {
                    <div class="conv-item d-flex align-items-center gap-2"
                         data-id="@g.ConversationId" data-type="group">
                        <img src="@(string.IsNullOrEmpty(g.PhotoUrl) ? "/images/avatars/group-avatar.png" : g.PhotoUrl)"
                             class="rounded-circle flex-shrink-0" width="42" height="42" />
                        <div class="flex-grow-1">
                            <div class="fw-bold">@g.DisplayTitle</div>
                            <div class="text-muted small">@g.LastMessage</div>
                        </div>
                    </div>
                }
            </div>



            <!-- (الكود الجديد) 🔽 شريط الإعدادات السفلي 🔽 -->
            <div class="sidebar-footer">

                <!-- (1) القائمة المنبثقة (مخفية) -->
                <div class="profile-menu-popup" id="profileMenu">
                    <a href="@Url.Action("Index", "Manage")" class="profile-menu-item">
                        <i class="bi bi-person-circle"></i>
                        <span>حسابي</span>
                    </a>
                    <form asp-controller="Account" asp-action="Logout" method="post" class="profile-menu-item">
                        <button type="submit" class="logout-btn">
                            <i class="bi bi-box-arrow-right"></i>
                            <span>تسجيل الخروج</span>
                        </button>
                    </form>
                </div>

                <!-- (2) الأزرار (الأيقونات) -->
                <div class="profile-triggers">
                    <!-- (1) إضافة اسم المستخدم) -->
                    <span class="user-name-display">@displayName</span>

                    <!-- (2) حاوية الأيقونات) -->
                    <div class="profile-icons">
                        <button id="profileMenuBtn" class="profile-btn" title="حسابي">
                            <i class="bi bi-person"></i>
                        </button>
                        <button class="profile-btn" title="الاعدادات (مستقبلاً)">
                            <i class="bi bi-gear"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- (انتهى الكود الجديد) 🔼 -->
        </div>

        <!-- 🔹 منطقة الرسائل -->
        <div class="chat-messages">
           
            <div id="chatHeader" style="display:none;">
                <div class="d-flex align-items-center gap-3">
                    <div class="position-relative">
                        <img id="chatHeaderPhoto" src="/images/default-avatar.png" width="50" height="50" class="rounded-circle" style="border: 2px solid #7b68ee;" />
                        <span id="onlineStatusBadge" class="position-absolute bottom-0 end-0 bg-success border border-2 border-white rounded-circle" style="width: 14px; height: 14px; display: none;"></span>
                    </div>
                    <div class="flex-grow-1">
                        <div id="chatHeaderName" class="fw-bold fs-5" style="margin-bottom: 2px;"></div>
                        <div id="chatHeaderStatus" class="text-muted small"></div>
                    </div>
                </div>
                <button id="btnGroupInfo" class="info-btn d-none" title="تفاصيل المجموعة">ℹ️</button>
            </div>

            <div id="chatBody" class="chat-body">
                <div id="emptyState">
                    <span style="letter-spacing:1px;">Tawasul 💬</span>
                    <small>ابدأ محادثة جديدة أو اختر جهة اتصال</small>
                </div>
            </div>

            <!-- 🔹 معاينة المرفق قبل الإرسال -->
            <div id="filePreviewArea" class="p-2 text-center border-top bg-white d-none">
                <div id="filePreviewContent"></div>
                <div class="mt-2">
                    <button id="btnEditImage" class="btn btn-sm btn-outline-secondary d-none">✏️ تعديل الصورة</button>
                    <button id="btnRemovePreview" class="btn btn-sm btn-danger">❌ إلغاء</button>
                </div>
            </div>


            <div class="chat-input" id="chatInputArea">
                <!-- 🔽🔽 (انقل الحاوية إلى هنا) 🔽🔽 -->
                <div class="emoji-picker-container" id="emojiPickerContainer">
                    <emoji-picker></emoji-picker>
                </div>
                <!-- 🔼🔼 (انتهى النقل) 🔼🔼 -->
                <input type="file" id="fileInput" class="d-none" />
                <button type="button" id="attachBtn" class="btn btn-outline-secondary">📎</button>
                <!-- 🔽🔽 (أضف هذا الزر هنا) 🔽🔽 -->
                <button type="button" id="emojiBtn" class="btn btn-outline-secondary">
                    <i class="bi bi-emoji-smile"></i>
                </button>
                <!-- 🔼🔼 (انتهى التعديل) 🔼🔼 -->
                <input id="messageInput" type="text" placeholder="اكتب رسالتك..." disabled />
                <div id="filePreviewBox" class="w-100 p-2 bg-light border-top text-center d-none">
                    <div id="filePreviewContent"></div>
                    <div class="mt-2 d-flex justify-content-center gap-2">
                        <button id="btnPreviewFile" class="btn btn-outline-primary btn-sm">📄 معاينة</button>
                        <button id="btnCancelFile" class="btn btn-danger btn-sm">❌ إلغاء</button>
                    </div>
                </div>

                <button id="sendBtn" disabled>إرسال</button>
            </div>

        </div>
    </div>

    <!-- نافذة إنشاء مجموعة جديدة -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إنشاء مجموعة جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="groupNameInput" class="form-control" placeholder="أدخل اسم المجموعة..." />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveGroupBtn">إنشاء</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 🖼️ نافذة عرض الصورة بالحجم الكامل -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-0 rounded-4 overflow-hidden">
            <div class="modal-header border-0 p-3" style="background: rgba(0,0,0,0.5);">
                <button type="button" class="btn-close btn-close-white ms-auto" 
                        data-bs-dismiss="modal" 
                        aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" style="max-height: 70vh; display: flex; align-items: center; justify-content: center; background: #000;">
                <img id="previewImage" src="" 
                     class="img-fluid" 
                     style="max-height: 65vh; max-width: 100%; object-fit: contain;">
            </div>
            <div class="modal-footer border-0 justify-content-center p-3" style="background: rgba(0,0,0,0.5);">
                <a id="downloadImageBtn" href="#" download
                   class="btn btn-light px-4 py-2 fw-bold rounded-pill">
                    <i class="bi bi-download me-2"></i>
                    تحميل الصورة
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 🎥 نافذة عرض الفيديو بالحجم الكامل -->
<div class="modal fade" id="videoPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-0 rounded-4 overflow-hidden">
            <div class="modal-header border-0 p-3" style="background: rgba(0,0,0,0.5);">
                <button type="button" class="btn-close btn-close-white ms-auto" 
                        data-bs-dismiss="modal" 
                        aria-label="إغلاق"></button>
            </div>
            <div class="modal-body p-0" style="max-height: 70vh; display: flex; align-items: center; justify-content: center; background: #000;">
                <video id="previewVideo" controls class="w-100" style="max-height: 65vh; object-fit: contain;">
                    متصفحك لا يدعم تشغيل الفيديو.
                </video>
            </div>
            <div class="modal-footer border-0 justify-content-center p-3" style="background: rgba(0,0,0,0.5);">
                <a id="downloadVideoBtn" href="#" download 
                   class="btn btn-light px-4 py-2 fw-bold rounded-pill">
                    <i class="bi bi-download me-2"></i>
                    تحميل الفيديو
                </a>
            </div>
        </div>
    </div>
</div>


<!-- 📄 نافذة عرض الملفات (PDF / DOCX / XLSX) -->
<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-0 rounded-4 overflow-hidden">
            <div class="modal-header border-0 p-3" style="background: rgba(0,0,0,0.8);">
                <h5 class="modal-title text-white fw-bold">
                    <i class="bi bi-file-earmark-text me-2"></i>
                    معاينة الملف
                </h5>
                <button type="button" class="btn-close btn-close-white ms-auto" 
                        data-bs-dismiss="modal" 
                        aria-label="إغلاق"></button>
            </div>
            <div class="modal-body p-0" style="height: 65vh;">
                <iframe id="previewFileFrame" src="" 
                        width="100%" 
                        height="100%" 
                        style="border:none; background:#1f2937;"></iframe>
            </div>
            <div class="modal-footer border-0 justify-content-center p-3" style="background: rgba(0,0,0,0.8);">
                <a id="downloadFileBtn" href="#" download 
                   class="btn btn-light px-4 py-2 fw-bold rounded-pill">
                    <i class="bi bi-download me-2"></i>
                    تحميل الملف
                </a>
            </div>
        </div>
    </div>
</div>


<!-- 🔽🔽 (أضف هذا السطر هنا) 🔽🔽 -->
<!-- (مكتبة الإيموجي - يجب أن تكون "module") -->
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1/index.js"></script>
<!-- 🔼🔼 (انتهى التعديل) 🔼🔼 -->

<!-- 🧩 سكربت -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script>
    // المتغيرات العامة
    let currentConvId = null;
    let currentType = null;
    let fabricCanvas = null;
    let currentDrawingColor = '#ff0000';
    let currentDrawingWidth = 3;
    const currentUserId = "@userId";

    // عند تحميل الصفحة
    $(document).ready(() => {
        const params = new URLSearchParams(window.location.search);
        const openId = params.get("open");

        if (!openId) {
            $("#chatInputArea").hide();
            $("#emptyState").show();
        } else {
            $(`.conv-item[data-id='${openId}']`).trigger("click");
        }

        // قائمة الحساب
        $("#profileMenuBtn").on("click", function(e) {
            e.stopPropagation();
            $("#profileMenu").toggleClass("active");
        });

        $(document).on("click", function() {
            $("#profileMenu").removeClass("active");
        });

        $("#profileMenu").on("click", function(e) {
            e.stopPropagation();
        });
    });

    // عند الضغط على محادثة
    $(document).on("click", ".conv-item", function () {
        $(".conv-item").removeClass("active");
        $(this).addClass("active");

        $("#emptyState").hide();
        $("#chatInputArea").show();

        const id = $(this).data("id");
        const type = $(this).data("type");
        currentConvId = id;
        currentType = type;

        const name = $(this).find(".fw-bold:first").text().trim();
        const photo = $(this).find("img").attr("src") || "/images/avatars/default-avatar.png";

        $("#chatHeaderPhoto").attr("src", photo);
        $("#chatHeaderName").text(name);
        $("#chatHeader").show();

        if (type === "group") {
            $("#btnGroupInfo").removeClass("d-none").data("group-id", id);
            $("#onlineStatusBadge").hide();
            $("#chatHeaderStatus").text("");
        } else {
            $("#btnGroupInfo").addClass("d-none");
            
            $.get(`/Chat/GetUserStatus?conversationId=${id}`, function(data) {
                if (data.isOnline) {
                    $("#onlineStatusBadge").show().removeClass("bg-secondary").addClass("bg-success");
                    $("#chatHeaderStatus").text("متصل الآن").css("color", "#10b981");
                } else if (data.lastSeenAt) {
                    $("#onlineStatusBadge").show().removeClass("bg-success").addClass("bg-secondary");
                    const lastSeen = new Date(data.lastSeenAt);
                    const now = new Date();
                    const diff = now - lastSeen;
                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(minutes / 60);
                    const days = Math.floor(hours / 24);
                    
                    let statusText = "";
                    if (minutes < 1) statusText = "آخر ظهور منذ لحظات";
                    else if (minutes < 60) statusText = `آخر ظهور منذ ${minutes} دقيقة`;
                    else if (hours < 24) statusText = `آخر ظهور منذ ${hours} ساعة`;
                    else statusText = `آخر ظهور منذ ${days} يوم`;
                    
                    $("#chatHeaderStatus").text(statusText).css("color", "#6b7280");
                } else {
                    $("#onlineStatusBadge").hide();
                    $("#chatHeaderStatus").text("");
                }
            });
        }

        $("#chatBody").html('<div class="text-center text-muted mt-5">جارٍ تحميل الرسائل...</div>');
        $("#messageInput, #sendBtn").prop("disabled", false);

        $.get(`/Chat/LoadMessages/${id}`, function (data) {
            $("#chatBody").empty();
            data.forEach(m => appendMessage(m));
        });

        $(this).find(".badge-unread").remove();
    });

    // إرسال الرسائل
    $("#sendBtn").click(sendMessage);
    $("#messageInput").keypress(function(e) {
        if (e.which === 13) {
            const text = $("#messageInput").val().trim();
            const file = $("#fileInput")[0].files[0];
            if (text || file) {
                sendMessage();
                e.preventDefault();
            }
        }
    });

    $("#messageInput").on("input", function() {
        const text = $(this).val().trim();
        const file = $("#fileInput")[0].files[0];
        $("#sendBtn").prop("disabled", !(text || file));
    });

    function sendMessage() {
        const text = $("#messageInput").val().trim();
        const file = $("#fileInput")[0].files[0];

        if (!text && !file) return;

        const formData = new FormData();
        formData.append("conversationId", currentConvId);
        formData.append("text", text || "");

        if (file) {
            console.log("📎 نوع الملف المرسل:", file.type);
            formData.append("file", file);
        }

        $.ajax({
            url: "/Chat/SendMessage",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: (msg) => {
                appendMessage(msg);
                $("#messageInput").val("");
                $("#fileInput").val("");
                $("#filePreviewArea").addClass("d-none");
                $("#filePreviewBox").addClass("d-none");
                $("#filePreviewContent").empty();
                $("#btnEditImage").addClass("d-none");
                $("#sendBtn").prop("disabled", true);
            },
            error: (xhr) => {
                console.error("❌ خطأ في الإرسال:", xhr.responseText);
                alert("حدث خطأ أثناء إرسال الرسالة: " + xhr.responseText);
            }
        });
    }

    // إدارة الملفات
    $("#attachBtn").click(() => $("#fileInput").click());

    $("#fileInput").on("change", function () {
        const file = this.files[0];
        const text = $("#messageInput").val().trim();

        if (file) {
            $("#sendBtn").prop("disabled", false);
            $("#messageInput").focus();
        } else if (!text) {
            $("#sendBtn").prop("disabled", true);
        }

        if (!file) return;

        const previewArea = $("#filePreviewArea");
        const previewBox = $("#filePreviewBox");
        const previewContent = $("#filePreviewContent");

        previewArea.addClass("d-none");
        previewBox.addClass("d-none");
        previewContent.empty();

        const type = file.type.toLowerCase();

        if (type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = e => {
                previewContent.html(`
                    <img id="previewImage" src="${e.target.result}"
                         class="img-fluid rounded shadow-sm"
                         style="max-height:300px; object-fit:contain;" />
                `);
                $("#btnEditImage").removeClass("d-none");
            };
            reader.readAsDataURL(file);
            previewArea.removeClass("d-none");
        }
        else if (type.startsWith("video/")) {
            const url = URL.createObjectURL(file);
            previewContent.html(`
                <video controls style="max-width:100%; border-radius:10px; max-height:300px;">
                    <source src="${url}" type="${type}">
                    متصفحك لا يدعم الفيديو.
                </video>
            `);
            $("#btnEditImage").addClass("d-none");
            previewArea.removeClass("d-none");
        }
        else if (type.startsWith("audio/")) {
            const url = URL.createObjectURL(file);
            previewContent.html(`
                <div class="d-flex flex-column align-items-center">
                    <audio controls style="width:100%; max-width:300px;">
                        <source src="${url}" type="${type}">
                        متصفحك لا يدعم الصوت.
                    </audio>
                    <div class="mt-2 text-muted small">${file.name}</div>
                </div>
            `);
            $("#btnEditImage").addClass("d-none");
            previewArea.removeClass("d-none");
        }
        else {
            const size = formatFileSize(file.size);
            previewContent.html(`
                <div class="d-flex align-items-center justify-content-center bg-white rounded p-2 shadow-sm">
                    <span class="me-2">📎</span>
                    <strong>${file.name}</strong>
                    <small class="text-muted ms-2">(${size})</small>
                </div>
            `);
            $("#btnEditImage").addClass("d-none");
            previewBox.removeClass("d-none");
        }
    });

    $("#btnRemovePreview").on("click", function () {
        $("#fileInput").val("");
        $("#filePreviewArea").addClass("d-none");
        $("#filePreviewBox").addClass("d-none");
        $("#filePreviewContent").empty();
        $("#btnEditImage").addClass("d-none");
    });

    // تعديل الصور
    $("#btnEditImage").on("click", function () {
        const img = document.getElementById("previewImage");
        if (!img) return;

        const modalHtml = `
            <div class="modal fade show" id="editImageModal" tabindex="-1" style="display: block; background: rgba(0,0,0,0.9);">
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content" style="background: #1f1f1f; border: none; border-radius: 16px; overflow: hidden;">
                        <div class="modal-header" style="border-bottom: 1px solid #333; padding: 1rem 1.5rem; background: #2a2a2a;">
                            <h5 class="modal-title text-white fw-bold">
                                <i class="bi bi-palette me-2"></i>تحرير الصورة
                            </h5>
                            <button type="button" class="btn-close btn-close-white" id="btnCloseEditor"></button>
                        </div>
                        
                        <!-- شريط الأدوات -->
                        <div class="p-3" style="background: #2a2a2a; border-bottom: 1px solid #444;">
                            <div class="d-flex flex-wrap gap-2 align-items-center justify-content-center">
                                <!-- أدوات الرسم -->
                                <button class="btn btn-sm btn-outline-light" id="btnDraw" title="رسم حر">
                                    <i class="bi bi-pencil"></i> رسم
                                </button>
                                <button class="btn btn-sm btn-outline-light" id="btnText" title="إضافة نص">
                                    <i class="bi bi-fonts"></i> نص
                                </button>
                                <button class="btn btn-sm btn-outline-light" id="btnCrop" title="اقتصاص الصورة">
                                    <i class="bi bi-crop"></i> اقتصاص
                                </button>
                                <button class="btn btn-sm btn-outline-light" id="btnRect" title="مستطيل">
                                    <i class="bi bi-square"></i> مربع
                                </button>
                                <button class="btn btn-sm btn-outline-light" id="btnCircle" title="دائرة">
                                    <i class="bi bi-circle"></i> دائرة
                                </button>
                                <button class="btn btn-sm btn-outline-light" id="btnArrow" title="سهم">
                                    <i class="bi bi-arrow-up-right"></i> سهم
                                </button>
                                
                                <div class="vr" style="height: 30px; background: #555;"></div>
                                
                                <!-- اختيار اللون -->
                                <div class="d-flex align-items-center gap-2">
                                    <label class="text-white small mb-0">اللون:</label>
                                    <input type="color" id="colorPicker" value="#ff0000" class="form-control form-control-sm" style="width: 50px; height: 35px; cursor: pointer;">
                                </div>
                                
                                <!-- حجم الخط/القلم -->
                                <div class="d-flex align-items-center gap-2">
                                    <label class="text-white small mb-0">الحجم:</label>
                                    <input type="range" id="brushSize" min="1" max="20" value="3" class="form-range" style="width: 100px;">
                                    <span class="text-white small" id="sizeValue">3</span>
                                </div>
                                
                                <div class="vr" style="height: 30px; background: #555;"></div>
                                
                                <!-- أدوات التحكم -->
                                <button class="btn btn-sm btn-outline-danger" id="btnDelete" title="حذف العنصر المحدد">
                                    <i class="bi bi-trash"></i> حذف
                                </button>
                                <button class="btn btn-sm btn-outline-warning" id="btnUndo" title="تراجع">
                                    <i class="bi bi-arrow-counterclockwise"></i> تراجع
                                </button>
                                <button class="btn btn-sm btn-outline-info" id="btnClear" title="مسح الكل">
                                    <i class="bi bi-eraser"></i> مسح الكل
                                </button>
                            </div>
                        </div>
                        
                        <div class="modal-body p-0" style="background: #1a1a1a; display: flex; align-items: center; justify-content: center; min-height: 500px;">
                            <canvas id="fabricCanvas"></canvas>
                        </div>
                        
                        <div class="modal-footer" style="border-top: 1px solid #333; padding: 1rem 1.5rem; background: #2a2a2a;">
                            <button type="button" class="btn btn-secondary" id="btnCancelEdit">
                                <i class="bi bi-x-circle me-1"></i>إلغاء
                            </button>
                            <button type="button" id="btnSaveEdit" class="btn btn-success px-4">
                                <i class="bi bi-check2-circle me-1"></i>حفظ التعديلات
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        
        $("body").append(modalHtml);
        
        // إنشاء Canvas
        fabricCanvas = new fabric.Canvas('fabricCanvas', {
            backgroundColor: '#1a1a1a',
            isDrawingMode: false
        });
        
        // تحميل الصورة
        fabric.Image.fromURL(img.src, function(oImg) {
            const canvasWidth = 800;
            const scale = canvasWidth / oImg.width;
            const canvasHeight = oImg.height * scale;
            
            fabricCanvas.setWidth(canvasWidth);
            fabricCanvas.setHeight(canvasHeight);
            
            oImg.set({
                scaleX: scale,
                scaleY: scale,
                selectable: false,
                evented: false
            });
            
            fabricCanvas.setBackgroundImage(oImg, fabricCanvas.renderAll.bind(fabricCanvas));
        });
        
        // تفعيل الرسم الحر
        $("#btnDraw").on("click", function() {
            fabricCanvas.isDrawingMode = true;
            fabricCanvas.freeDrawingBrush.color = currentDrawingColor;
            fabricCanvas.freeDrawingBrush.width = currentDrawingWidth;
            $(this).addClass("active");
            $("#btnText, #btnCrop, #btnRect, #btnCircle, #btnArrow").removeClass("active");
        });
        
        // إضافة نص
        $("#btnText").on("click", function() {
            fabricCanvas.isDrawingMode = false;
            const text = new fabric.IText('اكتب هنا...', {
                left: 100,
                top: 100,
                fontSize: parseInt($("#brushSize").val()) * 8,
                fill: currentDrawingColor,
                fontFamily: 'Arial'
            });
            fabricCanvas.add(text);
            fabricCanvas.setActiveObject(text);
            $(this).addClass("active");
            $("#btnDraw, #btnCrop").removeClass("active");
        });
        
        // اقتصاد الصورة - بالطريقة القديمة الشغالة
        $("#btnCrop").on("click", function() {
            fabricCanvas.isDrawingMode = false;
            
            // حذف أي زر "تطبيق اقتصاص" قديم
            $("#btnApplyCrop").remove();
            
            // حذف أي مستطيل اقتصاص قديم
            fabricCanvas.getObjects().forEach(obj => {
                if (obj.cropRect === true) {
                    fabricCanvas.remove(obj);
                }
            });
            
            // إنشاء مستطيل الاقتصاص
            const cropRect = new fabric.Rect({
                left: 50,
                top: 50,
                width: fabricCanvas.width - 100,
                height: fabricCanvas.height - 100,
                fill: 'rgba(0, 255, 0, 0.1)',
                stroke: '#00ff00',
                strokeWidth: 3,
                strokeDashArray: [10, 5],
                cornerColor: '#00ff00',
                cornerSize: 15,
                transparentCorners: false,
                lockRotation: true,
                hasRotatingPoint: false,
                borderColor: '#00ff00',
                cornerStrokeColor: '#00ff00',
                borderScaleFactor: 2,
                cropRect: true
            });
            
            fabricCanvas.add(cropRect);
            fabricCanvas.setActiveObject(cropRect);
            fabricCanvas.bringToFront(cropRect);
            fabricCanvas.renderAll();
            
            $(this).addClass("active btn-success");
            $("#btnDraw, #btnText, #btnRect, #btnCircle, #btnArrow").removeClass("active");
            
            // إضافة زر تطبيق الاقتصاص مرة واحدة فقط
            if ($("#btnApplyCrop").length === 0) {
                $(".modal-footer #btnCancelEdit").after(`
                    <button type="button" id="btnApplyCrop" class="btn btn-success me-2">
                        <i class="bi bi-scissors me-1"></i>تطبيق الاقتصاص
                    </button>
                `);
            }
            
            // عند تطبيق الاقتصاص
            $("#btnApplyCrop").off("click").on("click", function() {
                console.log("🔥 تطبيق الاقتصاص...");
                
                // الحصول على حدود المستطيل الدقيقة
                const bound = cropRect.getBoundingRect();
                console.log("📏 Bounds:", bound);
                
                // إنشاء canvas مؤقت
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = bound.width;
                tempCanvas.height = bound.height;
                const ctx = tempCanvas.getContext('2d');
                
                // الحصول على الصورة الأصلية من الخلفية
                const bgImage = fabricCanvas.backgroundImage;
                if (!bgImage) {
                    alert("⚠️ خطأ: لا توجد صورة للاقتصاص!");
                    return;
                }
                
                // حساب الإحداثيات بالنسبة للصورة الأصلية
                const scaleX = bgImage.scaleX || 1;
                const scaleY = bgImage.scaleY || 1;
                
                const sourceX = bound.left / scaleX;
                const sourceY = bound.top / scaleY;
                const sourceWidth = bound.width / scaleX;
                const sourceHeight = bound.height / scaleY;
                
                // رسم الجزء المقصوص
                const imgElement = bgImage._element;
                ctx.drawImage(
                    imgElement,
                    sourceX, sourceY, sourceWidth, sourceHeight,
                    0, 0, bound.width, bound.height
                );
                
                // تحويل لـ DataURL
                const croppedDataURL = tempCanvas.toDataURL('image/png', 1.0);
                console.log("✅ تم إنشاء الصورة المقصوصة");
                
                // حذف المستطيل
                fabricCanvas.remove(cropRect);
                
                // إعادة تحميل الصورة المقصوصة
                fabric.Image.fromURL(croppedDataURL, function(newImg) {
                    console.log("🖼️ تحميل الصورة المقصوصة...");
                    
                    // مسح كل شي
                    fabricCanvas.clear();
                    fabricCanvas.backgroundColor = '#1a1a1a';
                    
                    // تحديث حجم Canvas
                    fabricCanvas.setWidth(bound.width);
                    fabricCanvas.setHeight(bound.height);
                    
                    // إضافة الصورة الجديدة كخلفية
                    newImg.set({
                        left: 0,
                        top: 0,
                        selectable: false,
                        evented: false
                    });
                    
                    fabricCanvas.setBackgroundImage(newImg, fabricCanvas.renderAll.bind(fabricCanvas));
                    fabricCanvas.renderAll();
                    
                    console.log("✅ تم تطبيق الاقتصاص بنجاح!");
                });
                
                // إخفاء الزر وتنظيف
                $("#btnCrop").removeClass("active btn-success");
                $("#btnApplyCrop").remove();
            });
        });
        
        // رسم مستطيل
        $("#btnRect").on("click", function() {
            fabricCanvas.isDrawingMode = false;
            const rect = new fabric.Rect({
                left: 100,
                top: 100,
                fill: 'transparent',
                stroke: currentDrawingColor,
                strokeWidth: currentDrawingWidth,
                width: 150,
                height: 100
            });
            fabricCanvas.add(rect);
            $(this).addClass("active");
            $("#btnDraw, #btnCrop, #btnCircle").removeClass("active");
        });
        
        // رسم دائرة
        $("#btnCircle").on("click", function() {
            fabricCanvas.isDrawingMode = false;
            const circle = new fabric.Circle({
                left: 100,
                top: 100,
                fill: 'transparent',
                stroke: currentDrawingColor,
                strokeWidth: currentDrawingWidth,
                radius: 50
            });
            fabricCanvas.add(circle);
            $(this).addClass("active");
            $("#btnDraw, #btnCrop").removeClass("active");
        });
        
        // رسم سهم
        $("#btnArrow").on("click", function() {
            fabricCanvas.isDrawingMode = false;
            const arrow = new fabric.Path('M 0 0 L 100 0 L 90 -10 M 100 0 L 90 10', {
                left: 100,
                top: 100,
                stroke: currentDrawingColor,
                strokeWidth: currentDrawingWidth,
                fill: 'transparent'
            });
            fabricCanvas.add(arrow);
            $(this).addClass("active");
            $("#btnDraw, #btnCrop, #btnRect, #btnCircle").removeClass("active");
        });
        
        // تغيير اللون
        $("#colorPicker").on("change", function() {
            currentDrawingColor = $(this).val();
            if (fabricCanvas.isDrawingMode) {
                fabricCanvas.freeDrawingBrush.color = currentDrawingColor;
            }
            const activeObj = fabricCanvas.getActiveObject();
            if (activeObj) {
                if (activeObj.type === 'i-text') {
                    activeObj.set('fill', currentDrawingColor);
                } else {
                    activeObj.set('stroke', currentDrawingColor);
                }
                fabricCanvas.renderAll();
            }
        });
        
        // تغيير الحجم
        $("#brushSize").on("input", function() {
            currentDrawingWidth = parseInt($(this).val());
            $("#sizeValue").text(currentDrawingWidth);
            if (fabricCanvas.isDrawingMode) {
                fabricCanvas.freeDrawingBrush.width = currentDrawingWidth;
            }
            const activeObj = fabricCanvas.getActiveObject();
            if (activeObj && activeObj.type !== 'i-text') {
                activeObj.set('strokeWidth', currentDrawingWidth);
                fabricCanvas.renderAll();
            }
        });
        
        // حذف العنصر المحدد
        $("#btnDelete").on("click", function() {
            const activeObj = fabricCanvas.getActiveObject();
            if (activeObj) {
                fabricCanvas.remove(activeObj);
            }
        });
        
        // تراجع
        $("#btnUndo").on("click", function() {
            const objects = fabricCanvas.getObjects();
            if (objects.length > 0) {
                fabricCanvas.remove(objects[objects.length - 1]);
            }
        });
        
        // مسح الكل
        $("#btnClear").on("click", function() {
            fabricCanvas.getObjects().forEach(obj => {
                fabricCanvas.remove(obj);
            });
        });
        
        // حفظ التعديلات
        $("#btnSaveEdit").on("click", function() {
            const dataURL = fabricCanvas.toDataURL({
                format: 'png',
                quality: 1
            });
            
            $("#previewImage").attr("src", dataURL);
            
            // تحويل لـ Blob وتحديث FileInput
            fetch(dataURL)
                .then(res => res.blob())
                .then(blob => {
                    const file = new File([blob], "edited-image.png", { type: "image/png" });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    $("#fileInput")[0].files = dataTransfer.files;
                    
                    $("#editImageModal").remove();
                    fabricCanvas.dispose();
                    fabricCanvas = null;
                });
        });
        
        // إلغاء
        $("#btnCloseEditor, #btnCancelEdit").on("click", function() {
            $("#editImageModal").remove();
            if (fabricCanvas) {
                fabricCanvas.dispose();
                fabricCanvas = null;
            }
        });
    });

    // عرض الرسائل
    function appendMessage(m) {
        let filePreview = "";
        const name = m.fileName || "ملف مرفق";
        const type = (m.fileType || "").toLowerCase();
        const fileUrl = m.fileUrl;
        const fileSize = m.fileSize || 0;

        if (type.startsWith("image/")) {
            filePreview = `
                <div class="position-relative mt-2">
                    <img src="${fileUrl}" alt="${name}"
                         class="chat-image"
                         style="max-width:200px; max-height:200px; border-radius:12px; object-fit:cover; cursor:pointer;" />
                    <a href="${fileUrl}" download="${name}" class="btn btn-sm btn-light position-absolute bottom-0 end-0 m-2 shadow-sm">
                        ⬇️
                    </a>
                </div>`;
        }
        else if (type.startsWith("video/")) {
            filePreview = `
                <div class="position-relative mt-2">
                    <video class="chat-video" style="max-width:220px; max-height:200px; border-radius:12px; cursor:pointer;" controls>
                        <source src="${fileUrl}" type="${type}">
                        متصفحك لا يدعم تشغيل الفيديو.
                    </video>
                    <a href="${fileUrl}" download="${name}" class="btn btn-sm btn-light position-absolute bottom-0 end-0 m-2 shadow-sm">
                        ⬇️
                    </a>
                </div>`;
        }
        else if (type.startsWith("audio/")) {
            filePreview = `
                <div class="d-flex align-items-center mt-2 bg-light rounded p-2" style="max-width:240px;">
                    <audio controls style="width:180px;">
                        <source src="${fileUrl}" type="${type}">
                    </audio>
                    <a href="${fileUrl}" download="${name}" class="btn btn-sm btn-outline-secondary ms-2">⬇️</a>
                </div>`;
        }
        else if (fileUrl) {
            filePreview = `
            <div class="position-relative mt-2">
                <div class="chat-file d-flex align-items-center p-3 rounded shadow-sm"
                     data-file="${fileUrl}" data-type="${type}">
                    <div class="me-2 fs-4">📄</div>
                    <div class="file-info-container">
                        <div class="file-name">${name}</div>
                        <div class="file-details">
                            <span class="file-size">${formatFileSize(fileSize)}</span>
                            <span class="file-type">${type.split('/')[1] || 'ملف'}</span>
                        </div>
                    </div>
                </div>
                <a href="${fileUrl}" download="${name}" class="btn btn-sm btn-outline-secondary mt-2">⬇️ تحميل الملف</a>
            </div>`;
        }

        const html = `
        <div class="msg ${m.isMine ? "me" : "other"}" data-id="${m.id}">
            <div class="msg-content position-relative">
                ${m.text ? `<div>${m.text}</div>` : ""}
                ${filePreview}
                <div class="small mt-1 text-end opacity-75">
                    ${new Date(m.createdAtUtc).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
                ${m.isMine ? `
                    <div class="msg-actions">
                        <button class="btn btn-sm btn-light edit-msg">✏️</button>
                        <button class="btn btn-sm btn-danger delete-msg">🗑️</button>
                    </div>
                ` : ""}
            </div>
        </div>`;

        $("#chatBody").append(html);
        $("#chatBody").scrollTop($("#chatBody")[0].scrollHeight);
    }

    // تعديل وحذف الرسائل
    $(document).on("click", ".edit-msg", function () {
        const msgDiv = $(this).closest(".msg");
        const msgId = msgDiv.data("id");
        const oldText = msgDiv.find(".msg-content > div:first").text().trim();

        Swal.fire({
            title: "✏️ تعديل الرسالة",
            input: "textarea",
            inputValue: oldText,
            inputAttributes: { "aria-label": "نص الرسالة" },
            showCancelButton: true,
            confirmButtonText: "💾 حفظ التعديل",
            cancelButtonText: "إلغاء",
            confirmButtonColor: "#2563eb",
            cancelButtonColor: "#6c757d",
            background: "#fff",
            customClass: {
                popup: "rounded-4 shadow-lg p-4",
                title: "fw-bold fs-5 text-primary",
                confirmButton: "btn btn-primary px-4 fw-bold",
                cancelButton: "btn btn-secondary px-4 fw-bold"
            },
            preConfirm: (value) => {
                if (!value.trim()) {
                    Swal.showValidationMessage("الرجاء إدخال نص الرسالة.");
                }
                return value.trim();
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const newText = result.value;
                $.post("/Chat/EditMessage", { messageId: msgId, newText }, () => {
                    msgDiv.find(".msg-content > div:first").text(newText);

                    Swal.fire({
                        title: "✅ تم الحفظ",
                        text: "تم تعديل الرسالة بنجاح.",
                        icon: "success",
                        timer: 1200,
                        showConfirmButton: false
                    });
                });
            }
        });
    });

    $(document).on("click", ".delete-msg", function () {
        const msgDiv = $(this).closest(".msg");
        const msgId = msgDiv.data("id");

        Swal.fire({
            title: "🗑️ هل أنت متأكد؟",
            text: "سيتم حذف هذه الرسالة نهائيًا.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "نعم، احذفها",
            cancelButtonText: "إلغاء",
            reverseButtons: true,
            customClass: {
                popup: "rounded-4 shadow-lg p-4",
                title: "fw-bold fs-5",
                confirmButton: "btn btn-danger px-4 fw-bold",
                cancelButton: "btn btn-secondary px-4 fw-bold"
            }
        }).then((result) => {
            if (result.isConfirmed) {
                $.post("/Chat/DeleteMessage", { messageId: msgId, deleteForAll: true }, () => {
                    Swal.fire({
                        title: "✅ تم الحذف",
                        text: "تم حذف الرسالة بنجاح.",
                        icon: "success",
                        timer: 1300,
                        showConfirmButton: false
                    });
                    msgDiv.html('<div class="text-muted fst-italic">🚫 تم حذف هذه الرسالة</div>');
                });
            }
        });
    });

    // معاينة الوسائط
    $(document).on("click", ".chat-image", function () {
        const src = $(this).attr("src");
        const fileName = $(this).attr("alt") || "image";
        $("#previewImage").attr("src", src);
        $("#downloadImageBtn").attr("href", src);
        $("#downloadImageBtn").attr("download", fileName);
        $("#imagePreviewModal").modal("show");
    });

    $(document).on("click", ".chat-video", function () {
        const src = $(this).find("source").attr("src");
        $("#previewVideo").attr("src", src);
        $("#downloadVideoBtn").attr("href", src);
        $("#downloadVideoBtn").attr("download", "video.mp4");
        $("#videoPreviewModal").modal("show");
    });

    $('#videoPreviewModal').on('hidden.bs.modal', function () {
        const video = document.getElementById("previewVideo");
        if (video) {
            video.pause();
            video.currentTime = 0;
        }
    });

    // المجموعات والبحث
    $("#tab-chats").click(() => {
        $("#tab-chats").addClass("active");
        $("#tab-groups").removeClass("active");
        $("#chatList").removeClass("d-none");
        $("#groupList").addClass("d-none");
        $("#createGroupBox").hide();
        $("#userSearchInput").attr("placeholder", "ابحث بالإيميل أو رقم الهاتف...");
    });

    $("#tab-groups").click(() => {
        $("#tab-groups").addClass("active");
        $("#tab-chats").removeClass("active");
        $("#groupList").removeClass("d-none");
        $("#chatList").addClass("d-none");
        $("#createGroupBox").show();
        $("#userSearchInput").attr("placeholder", "ابحث باسم المجموعة...");
    });

    $("#btnNewGroup").click(() => $("#createGroupModal").modal("show"));

    $("#saveGroupBtn").click(() => {
        let title = $("#groupNameInput").val().trim();
        if (!title) return alert("الرجاء إدخال اسم المجموعة.");
        $.post("/Groups/Create", { title }, () => location.reload())
            .fail(() => alert("حدث خطأ أثناء إنشاء المجموعة."));
    });

    $("#userSearchInput").on("keyup", function () {
        const q = $(this).val().trim();
        if (q.length < 2) return $("#userSearchResults").empty();

        $.get(`/Chat/SearchUsers`, { query: q }, users => {
            const box = $("#userSearchResults");
            box.empty();

            if (users.length === 0) {
                box.html('<div class="text-muted text-center">لا يوجد نتائج</div>');
                return;
            }

            users.forEach(u => {
                box.append(`
                    <div class="d-flex align-items-center justify-content-between p-2 border rounded mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <img src="${u.photoUrl ?? '/images/default-avatar.png'}" width="35" height="35" class="rounded-circle" />
                            <div>
                                <strong>${u.displayName ?? "(مستخدم غير معروف)"}</strong><br/>
                                <small class="text-muted">${u.email ?? ""}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary btnStartChat" data-id="${u.id}">بدء محادثة</button>
                    </div>
                `);
            });
        });
    });

    $(document).on("click", ".btnStartChat", function () {
        const targetUserId = $(this).data("id");

        $.post("/Chat/StartChat", { targetUserId }, res => {
            if (res.conversationId) {
                location.href = `/Chat?open=${res.conversationId}`;
            } else {
                alert("حدث خطأ أثناء إنشاء المحادثة.");
            }
        }).fail(() => {
            alert("حدث خطأ أثناء محاولة بدء المحادثة.");
        });
    });

    $("#btnGroupInfo").on("click", function () {
        const id = $(this).data("group-id");
        if (id) window.location.href = `/Groups/Details/${id}`;
    });

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        if (bytes < 1024) return `${bytes} B`;
        const kb = bytes / 1024;
        if (kb < 1024) return `${kb.toFixed(1)} KB`;
        const mb = kb / 1024;
        if (mb < 1024) return `${mb.toFixed(1)} MB`;
        const gb = mb / 1024;
        return `${gb.toFixed(1)} GB`;
    }

    // SignalR
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/hubs/tawasul")
        .build();

    connection.on("ReceiveMessage", (msg) => {
        console.log("📩 Received:", msg);

        if (msg.senderId === currentUserId) return;

        if (msg.conversationId === currentConvId) {
            appendMessage(msg);
        } else {
            const item = $(`.conv-item[data-id='${msg.conversationId}']`);
            if (item.length) {
                let badge = item.find(".badge-unread");
                if (badge.length === 0) {
                    item.find(".fw-bold")
                        .after(`<span class="badge bg-primary rounded-pill badge-unread ms-2">1</span>`);
                } else {
                    let count = parseInt(badge.text()) || 0;
                    badge.text(count + 1);
                }
            }
        }
    });

    connection.on("MessageEdited", (msg) => {
        const div = $(`.msg[data-id='${msg.id}']`);
        div.find(".msg-content > div:first").text(msg.text);
    });

    connection.on("MessageDeleted", (data) => {
        const msgDiv = $(`.msg[data-id='${data.id}']`);

        if (msgDiv.length > 0) {
            if (data.deletedCompletely) {
                msgDiv.animate({
                    opacity: 0,
                    height: 0,
                    marginTop: 0,
                    marginBottom: 0,
                    paddingTop: 0,
                    paddingBottom: 0
                }, 300, function() {
                    $(this).remove();
                });
            } else {
                msgDiv.html('<div class="text-muted fst-italic">🚫 تم حذف هذه الرسالة</div>');
            }
        }
    });

    connection.start()
        .then(() => console.log("✅ Connected to ChatHub!"))
        .catch(err => console.error("❌ Hub Error:", err));

    $(document).on("click", ".conv-item", function () {
        const id = $(this).data("id");
        currentConvId = id;

        $(this).find(".badge-unread").remove();

        if (connection.state === signalR.HubConnectionState.Connected) {
            connection.invoke("JoinConversation", id.toString());
        }
    });




    // 🔽🔽 (أضف هذا الكود الجديد هنا) 🔽🔽
    // --- (الكود الجديد: إضافة الإيموجي) ---

    // (1) زر فتح "البوب أب"
    $("#emojiBtn").on("click", function (e) {
        e.stopPropagation();
        $("#emojiPickerContainer").toggleClass("active");
    });

    // (2) إغلاق "البوب أب" عند الضغط خارجه
    $(document).on("click", function () {
        $("#emojiPickerContainer").removeClass("active");
    });

    // (3) جلب الإيموجي عند الضغط عليه
    // (ملاحظة: هذا الكود "Vanilla JS" لأنه Web Component)
    document.querySelector('emoji-picker').addEventListener('emoji-click', event => {
        document.querySelector('emoji-picker')
        const emoji = event.detail.unicode;
        const input = $("#messageInput");

        // (إضافة الإيموجي للنص)
        input.val(input.val() + emoji);

        // (إعادة التركيز على الصندوق)
        input.focus();

        // (تفعيل زر الإرسال)
        $("#sendBtn").prop("disabled", false);
    });
    // --- 🔼 (انتهى الكود الجديد) 🔼 ---
</script>

