@model List<Tawasul.Models.ViewModels.ConversationListViewModel>
@inject Microsoft.AspNetCore.Identity.UserManager<Tawasul.Models.ApplicationUser> UserManager
@{
    ViewData["Title"] = "المحادثات";
    Layout = "_Layout";

    var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var currentUser = await UserManager.GetUserAsync(User);
    var displayName = currentUser?.DisplayName ?? currentUser?.Email ?? "مستخدم";
}
<link rel="stylesheet" href="~/css/IndexChat.css" asp-append-version="true" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<!-- Fabric.js للرسم والكتابة على الصور -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<div data-user-id="@userId"></div>
<div class="container mt-4">
    <div class="chat-container shadow-sm">

        <!-- 🔹 الشريط الجانبي -->
        <div class="chat-sidebar">
            <ul class="nav nav-tabs nav-fill border-bottom" id="chatTabs">
                <li class="nav-item">
                    <button class="nav-link active" id="tab-chats">💬 المحادثات</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="tab-groups">👥 المجموعات</button>
                </li>
            </ul>

            <div class="p-3 border-bottom">
                <input type="text" id="userSearchInput" class="form-control" placeholder="ابحث بالإيميل أو رقم الهاتف..." />
                <div id="userSearchResults" class="mt-2"></div>
            </div>

            <!-- قائمة المحادثات -->
            <div id="chatList">
                @foreach (var c in Model.Where(x => x.Type == "Chat"))
                {
                    <div class="conv-item d-flex align-items-center gap-2"
                         data-id="@c.ConversationId" data-type="chat">
                        <img src="@(string.IsNullOrEmpty(c.PhotoUrl) ? "/images/avatars/default-avatar.png" : c.PhotoUrl)"
                             class="rounded-circle flex-shrink-0" width="42" height="42" />
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="fw-bold">@c.DisplayTitle</div>
                                @if (c.UnreadCount > 0)
                                {
                                    <span class="badge bg-primary rounded-pill badge-unread">@c.UnreadCount</span>
                                }
                            </div>
                            <div class="text-muted small">@c.LastMessage</div>
                        </div>
                    </div>
                }
            </div>


            <!-- إنشاء مجموعة جديدة -->
            <div class="p-3 border-bottom text-center" id="createGroupBox" style="display:none;">
                <button class="btn btn-primary w-100" id="btnNewGroup">➕ إنشاء مجموعة جديدة</button>
            </div>

            <!-- قائمة المجموعات -->
            <div id="groupList" class="d-none">
                @foreach (var g in Model.Where(x => x.Type == "Group"))
                {
                    <div class="conv-item d-flex align-items-center gap-2"
                         data-id="@g.ConversationId" data-type="group">
                        <img src="@(string.IsNullOrEmpty(g.PhotoUrl) ? "/images/avatars/group-avatar.svg" : g.PhotoUrl)"
                             class="rounded-circle flex-shrink-0" width="42" height="42" />
                        <div class="flex-grow-1">
                            <div class="fw-bold">@g.DisplayTitle</div>
                            <div class="text-muted small">@g.LastMessage</div>
                        </div>
                    </div>
                }
            </div>



            <!-- (الكود الجديد) 🔽 شريط الإعدادات السفلي 🔽 -->
            <div class="sidebar-footer">

                <!-- (1) القائمة المنبثقة (مخفية) -->
                <div class="profile-menu-popup" id="profileMenu">
                    <a href="@Url.Action("Index", "Manage")" class="profile-menu-item">
                        <i class="bi bi-person-circle"></i>
                        <span>حسابي</span>
                    </a>
                    <form asp-controller="Account" asp-action="Logout" method="post" class="profile-menu-item">
                        <button type="submit" class="logout-btn">
                            <i class="bi bi-box-arrow-right"></i>
                            <span>تسجيل الخروج</span>
                        </button>
                    </form>
                </div>

                <!-- (2) الأزرار (الأيقونات) -->
                <div class="profile-triggers">
                    <!-- (1) إضافة اسم المستخدم) -->
                    <span class="user-name-display">@displayName</span>

                    <!-- (2) حاوية الأيقونات) -->
                    <div class="profile-icons">
                        <button id="profileMenuBtn" class="profile-btn" title="حسابي">
                            <i class="bi bi-person"></i>
                        </button>
                        <button class="profile-btn" title="الاعدادات (مستقبلاً)">
                            <i class="bi bi-gear"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- (انتهى الكود الجديد) 🔼 -->
        </div>

        <!-- 🔹 منطقة الرسائل -->
        <div class="chat-messages">

            <div id="chatHeader" class="chat-header-rtl"  style="display:none;">
                <div class="d-flex align-items-center gap-3">
                    <div class="position-relative">
                        <img id="chatHeaderPhoto" src="/images/avatars/default-avatar.png" width="50" height="50"
                             class="rounded-circle" style="border: 2px solid #7b68ee;" />
                        <span id="onlineStatusBadge"
                              class="position-absolute bottom-0 end-0 bg-success border border-2 border-white rounded-circle"
                              style="width:14px;height:14px;display:none;"></span>
                    </div>

                    <div class="flex-grow-1">
                        <div id="chatHeaderName" class="fw-bold fs-5" style="margin-bottom:2px;"></div>
                        <div id="chatHeaderStatus" class="text-muted small"></div>
                    </div>

                    <!-- الأيقونة تكون شمال الاسم والصورة -->
                    <button id="btnPeerInfo" class="info-btn d-none ms-2" title="معلومات جهة الاتصال">
                        <i class="bi bi-info-circle"></i>
                    </button>
                    <button id="convSearchBtn" class="info-btn ms-2" title="بحث في هذه المحادثة">
                        <i class="bi bi-search"></i>
                    </button>


                    <button id="btnGroupInfo" class="info-btn d-none ms-2" title="تفاصيل المجموعة">
                        <i class="bi bi-people"></i>
                    </button>
                </div>
            </div>


            <div id="chatBody" class="chat-body">
                <div id="emptyState">
                    <span style="letter-spacing:1px;">Tawasul 💬</span>
                    <small>ابدأ محادثة جديدة أو اختر جهة اتصال</small>
                </div>
            </div>

            <!-- 🔹 معاينة المرفق قبل الإرسال -->
            <div id="filePreviewArea" class="p-2 text-center border-top bg-white d-none">
                <div id="filePreviewContent"></div>
                <div class="mt-2">
                    <button id="btnEditImage" class="btn btn-sm btn-outline-secondary d-none">✏️ تعديل الصورة</button>
                    <button id="btnRemovePreview" class="btn btn-sm btn-danger">❌ إلغاء</button>
                </div>
            </div>


            <div class="chat-input" id="chatInputArea">
                <!-- 🔽🔽 (انقل الحاوية إلى هنا) 🔽🔽 -->
                <div class="emoji-picker-container" id="emojiPickerContainer">
                    <emoji-picker></emoji-picker>
                </div>
                <!-- 🔼🔼 (انتهى النقل) 🔼🔼 -->
                <input type="file" id="fileInput" class="d-none" />
                <button type="button" id="attachBtn" class="btn btn-outline-secondary">📎</button>
                <!-- 🔽🔽 (أضف هذا الزر هنا) 🔽🔽 -->
                <button type="button" id="emojiBtn" class="btn btn-outline-secondary">
                    <i class="bi bi-emoji-smile"></i>
                </button>
                <!-- 🔼🔼 (انتهى التعديل) 🔼🔼 -->
                <input id="messageInput" type="text" placeholder="اكتب رسالتك..." disabled />
                <div id="filePreviewBox" class="w-100 p-2 bg-light border-top text-center d-none">
                    <div id="filePreviewContentBox"></div> <!-- ⬅️ اسم جديد -->
                    <div class="mt-2 d-flex justify-content-center gap-2">
                        <button id="btnPreviewFile" class="btn btn-outline-primary btn-sm">📄 معاينة</button>
                        <button id="btnCancelFile" class="btn btn-danger btn-sm">❌ إلغاء</button>
                    </div>
                </div>

                <div id="replyPreview" class="reply-chip d-none" dir="rtl">
                    <div class="reply-chip__bar"></div>
                    <div class="reply-chip__content">
                        <div class="reply-chip__title">ردًّا على</div>
                        <div class="reply-chip__snippet" id="replyTextPreview"></div>
                    </div>
                    <button id="cancelReply" class="reply-chip__close" type="button" aria-label="إلغاء">×</button>
                </div>



                <button id="sendBtn" disabled>إرسال</button>
            </div>

        </div>
    </div>

    <!-- نافذة إنشاء مجموعة جديدة -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إنشاء مجموعة جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="groupNameInput" class="form-control" placeholder="أدخل اسم المجموعة..." />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveGroupBtn">إنشاء</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 🖼️ نافذة عرض الصورة بالحجم الكامل -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-0 rounded-4 overflow-hidden">
            <div class="modal-header border-0 p-3" style="background: rgba(0,0,0,0.5);">
                <button type="button" class="btn-close btn-close-white ms-auto" 
                        data-bs-dismiss="modal" 
                        aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" style="max-height: 70vh; display: flex; align-items: center; justify-content: center; background: #000;">
                <img id="previewImage" src="" 
                     class="img-fluid" 
                     style="max-height: 65vh; max-width: 100%; object-fit: contain;">
            </div>
            <div class="modal-footer border-0 justify-content-center p-3" style="background: rgba(0,0,0,0.5);">
                <a id="downloadImageBtn" href="#" download
                   class="btn btn-light px-4 py-2 fw-bold rounded-pill">
                    <i class="bi bi-download me-2"></i>
                    تحميل الصورة
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 🎥 نافذة عرض الفيديو بالحجم الكامل -->
<div class="modal fade" id="videoPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-0 rounded-4 overflow-hidden">
            <div class="modal-header border-0 p-3" style="background: rgba(0,0,0,0.5);">
                <button type="button" class="btn-close btn-close-white ms-auto" 
                        data-bs-dismiss="modal" 
                        aria-label="إغلاق"></button>
            </div>
            <div class="modal-body p-0" style="max-height: 70vh; display: flex; align-items: center; justify-content: center; background: #000;">
                <video id="previewVideo" controls class="w-100" style="max-height: 65vh; object-fit: contain;">
                    متصفحك لا يدعم تشغيل الفيديو.
                </video>
            </div>
            <div class="modal-footer border-0 justify-content-center p-3" style="background: rgba(0,0,0,0.5);">
                <a id="downloadVideoBtn" href="#" download 
                   class="btn btn-light px-4 py-2 fw-bold rounded-pill">
                    <i class="bi bi-download me-2"></i>
                    تحميل الفيديو
                </a>
            </div>
        </div>
    </div>
</div>


<!-- 📄 نافذة عرض الملفات (PDF / DOCX / XLSX) -->
<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-0 rounded-4 overflow-hidden">
            <div class="modal-header border-0 p-3" style="background: rgba(0,0,0,0.8);">
                <h5 class="modal-title text-white fw-bold">
                    <i class="bi bi-file-earmark-text me-2"></i>
                    معاينة الملف
                </h5>
                <button type="button" class="btn-close btn-close-white ms-auto" 
                        data-bs-dismiss="modal" 
                        aria-label="إغلاق"></button>
            </div>
            <div class="modal-body p-0" style="height: 65vh;">
                <iframe id="previewFileFrame" src="" 
                        width="100%" 
                        height="100%" 
                        style="border:none; background:#1f2937;"></iframe>
            </div>
            <div class="modal-footer border-0 justify-content-center p-3" style="background: rgba(0,0,0,0.8);">
                <a id="downloadFileBtn" href="#" download 
                   class="btn btn-light px-4 py-2 fw-bold rounded-pill">
                    <i class="bi bi-download me-2"></i>
                    تحميل الملف
                </a>
            </div>
        </div>
    </div>
</div>


<!-- Edit Message Modal -->
<div class="modal fade" id="editMsgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content edit-modal">
            <div class="modal-header">
                <h5 class="modal-title"><span>✏️</span> تعديل الرسالة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-pills mb-3" id="editTabs">
                    <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tabText">نص</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabFile">مرفق</button></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="tabText">
                        <textarea id="editMsgText" class="form-control" rows="5" placeholder="اكتب النص الجديد هنا"></textarea>
                        <div class="form-text mt-2">يمكن تركه فارغًا إذا ستستبدل الرسالة بمرفق.</div>
                    </div>
                    <div class="tab-pane fade" id="tabFile">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <input type="file" id="editMsgFile" class="form-control"
                                   accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" />
                            <button class="btn btn-outline-secondary" id="btnRemoveExistingFile" type="button">🗑️ إزالة المرفق الحالي</button>
                        </div>
                        <div id="editFilePreview" class="border rounded p-3 bg-light small text-muted">لا يوجد مرفق.</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <div id="editMsgError" class="text-danger small d-none"></div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveEditMsgBtn">💾 حفظ التعديل</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal: معلومات جهة الاتصال -->
<div class="modal fade" id="peerInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header" style="border-bottom:1px solid var(--border)">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-person-vcard me-2"></i>معلومات جهة الاتصال
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body">
                <!-- Header -->
                <div class="d-flex align-items-center gap-3 mb-3">
                    <img id="piPhoto" src="/images/avatars/default-avatar.png" class="rounded-circle border" width="64" height="64" />
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center gap-2">
                            <div id="piName" class="fw-bold fs-5">—</div>
                            <span id="piOnlineDot" class="badge rounded-pill bg-secondary" title="الحالة">غير متصل</span>
                        </div>
                        <div id="piLastSeen" class="text-muted small">—</div>
                    </div>
                </div>

                <!-- Privacy-safe fields -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <div class="p-3 rounded-3 border">
                            <div class="text-muted small mb-1">البريد الإلكتروني </div>
                            <div id="piEmail">—</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 rounded-3 border">
                            <div class="text-muted small mb-1">رقم الهاتف </div>
                            <div id="piPhone">—</div>
                        </div>
                    </div>
                </div>
                <button id="globalSearchBtn" class="profile-btn" title="بحث">
                    <i class="bi bi-search"></i>
                </button>


                <!-- فلاتر الوسائط -->
                <div id="piMediaFilters" class="media-filters btn-group mb-3" role="group" aria-label="Media filters">
                    <button type="button" class="btn btn-outline-secondary active" data-kind="all">الكل</button>
                    <button type="button" class="btn btn-outline-secondary" data-kind="image">صور</button>
                    <button type="button" class="btn btn-outline-secondary" data-kind="video">فيديو</button>
                    <button type="button" class="btn btn-outline-secondary" data-kind="audio">صوت</button>
                    <button type="button" class="btn btn-outline-secondary" data-kind="file">ملفات</button>
                    <button type="button" class="btn btn-outline-secondary" data-kind="link">روابط</button>
                </div>

                <!-- الشبكة كما هي -->
                <div id="piMediaGrid" class="row g-2"></div>

                <!-- زر تحميل المزيد -->
                <div class="text-center mt-2">
                    <button id="piMediaMore" class="btn btn-outline-primary d-none">عرض المزيد</button>
                </div>


                <!-- آخر الوسائط المشتركة -->
                <div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="fw-bold">آخر الوسائط في هذه المحادثة</div>
                     
                    </div>
                    <div id="piMediaGrid" class="row g-2">
                        <!-- يُملأ ديناميكياً -->
                    </div>
                </div>

                <!-- Safety actions -->
                <div class="mt-3 p-3 rounded-3" style="background:#fff8f8; border:1px solid #fee2e2">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="text-muted small">حافظ على الخصوصية: لا نعرض أي معلومات غير مرئية لصاحب الحساب.</div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-danger btn-sm" id="piBlockBtn" disabled title="لاحقاً">
                                <i class="bi bi-slash-circle me-1"></i>حظر
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="piReportBtn" disabled title="لاحقاً">
                                <i class="bi bi-flag me-1"></i>إبلاغ
                            </button>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer" style="border-top:1px solid var(--border)">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="searchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content rounded-4">
            <div class="modal-header">
                <h5 class="modal-title">بحث</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="d-flex gap-2 mb-2">
                    <input id="searchInput" class="form-control" placeholder="اكتب كلمة أو اسم ملف أو جزء من رابط…" />
                    <button id="searchGoBtn" class="btn btn-primary">بحث</button>
                </div>

                <div class="btn-group mb-3" role="group" aria-label="filters">
                    <input type="radio" class="btn-check" name="s-kind" id="skAll" autocomplete="off" checked>
                    <label class="btn btn-outline-secondary" for="skAll">الكل</label>

                    <input type="radio" class="btn-check" name="s-kind" id="skMsg" autocomplete="off">
                    <label class="btn btn-outline-secondary" for="skMsg">رسائل</label>

                    <input type="radio" class="btn-check" name="s-kind" id="skFiles" autocomplete="off">
                    <label class="btn btn-outline-secondary" for="skFiles">ملفات</label>

                    <input type="radio" class="btn-check" name="s-kind" id="skLinks" autocomplete="off">
                    <label class="btn btn-outline-secondary" for="skLinks">روابط</label>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="limitToCurrent">
                    <label class="form-check-label" for="limitToCurrent">
                        حصر البحث بالمحادثة المفتوحة حالياً
                    </label>
                </div>

                <div id="searchResults" class="list-group small" style="max-height:50vh;overflow:auto"></div>
            </div>

            <div class="modal-footer">
                <button id="sendResultsToChat" class="btn btn-outline-primary" disabled>📩 أرسل النتائج إلى الشات</button>
                <button class="btn btn-light" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>




<!-- 🧩 سكربت -->
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script src="~/js/IndexChat.js"></script>



